<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WODPulse - Desafios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        :root {
            --primary: #FF9800;
            --dark-bg: #0f0f0f;
            --card-bg: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --success: #4CAF50;
            --error: #f44336;
            --pending: #FFC107;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--dark-bg); color: white; font-family: 'Inter', sans-serif; padding-bottom: 80px; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .header { margin-bottom: 30px; }
        .header h1 { font-size: 1.8rem; color: var(--primary); }

        .section-title { font-size: 1.2rem; margin: 20px 0 15px; display: flex; align-items: center; gap: 10px; }

        /* Novo Card de Cria√ß√£o de Desafio */
        .create-challenge-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        
        .athlete-selector {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .athlete-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }
        .athlete-option:hover { background: #333; }
        .athlete-option input { width: 18px; height: 18px; accent-color: var(--primary); }
        .athlete-option img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }

        .search-input {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .btn-submit {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Cards de Desafio */
        .challenge-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
            position: relative;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .challenge-type {
            background: rgba(255, 152, 0, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .challenge-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }

        .athlete-v {
            text-align: center;
            flex: 1;
        }

        .athlete-v img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #444; margin-bottom: 5px; }
        .athlete-v span { display: block; font-size: 0.8rem; color: var(--text-secondary); }

        .vs-circle {
            width: 30px;
            height: 30px;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--primary);
        }

        .challenge-status {
            text-align: center;
            font-size: 0.8rem;
            padding: 8px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .status-pending { background: rgba(255, 193, 7, 0.1); color: var(--pending); }
        .status-accepted { background: rgba(76, 175, 80, 0.1); color: var(--success); }
        .status-rejected { background: rgba(244, 67, 54, 0.1); color: var(--error); }

        .challenge-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-action {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: none;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-accept { background: var(--success); color: white; }
        .btn-reject { background: var(--error); color: white; }
        .btn-ranking { background: #333; color: white; border: 1px solid #444; }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #555;
            cursor: pointer;
            padding: 5px;
        }
        .delete-btn:hover { color: var(--error); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 20px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .ranking-pos { font-weight: bold; color: var(--primary); width: 25px; }
        .ranking-item img { width: 30px; height: 30px; border-radius: 50%; }
        .ranking-value { margin-left: auto; font-weight: bold; }

        /* Bulk Delete */
        .bulk-actions {
            display: none;
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 100;
            font-weight: bold;
        }

        .challenge-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            accent-color: var(--error);
        }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid #333; }
        .nav-item { color: var(--text-secondary); font-size: 1.5rem; text-decoration: none; }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Desafios WODPulse</h1>
        </div>

        <!-- Criar Desafio -->
        <div class="create-challenge-card">
            <div class="section-title"><i class="fas fa-plus-circle"></i> Novo Desafio</div>
            
            <div class="form-group">
                <label>Selecione o(s) Oponente(s)</label>
                <input type="text" class="search-input" id="athleteSearch" placeholder="Buscar atletas..." oninput="filterAthletes()">
                <div class="athlete-selector" id="athleteList">
                    <div style="padding: 10px; color: #666; text-align: center;">Carregando atletas...</div>
                </div>
            </div>

            <div class="form-group">
                <label>Tipo de Desafio</label>
                <select class="search-input" id="challengeType">
                    <option value="AMRAP 15min">AMRAP 15min (Repeti√ß√µes)</option>
                    <option value="For Time: 100 Burpees">For Time: 100 Burpees (Tempo)</option>
                    <option value="Max Weight: Deadlift">Max Weight: Deadlift (Carga)</option>
                    <option value="Murph">Murph (Tempo)</option>
                    <option value="Check-in Streak (7 dias)">Check-in Streak (7 dias)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Dura√ß√£o (dias)</label>
                <input type="number" class="search-input" id="challengeDuration" value="7" min="1">
            </div>

            <button class="btn-submit" onclick="createChallenge()" id="btnCreate">Lan√ßar Desafio! üöÄ</button>
        </div>

        <!-- Lista de Desafios -->
        <div class="section-title"><i class="fas fa-fire"></i> Seus Desafios</div>
        <div id="challengesList">
            <div style="text-align:center; padding:20px;">Carregando desafios...</div>
        </div>
    </div>

    <!-- Bulk Delete Button -->
    <div id="bulkDeleteBtn" class="bulk-actions" onclick="bulkDelete()">
        <i class="fas fa-trash"></i> Excluir Selecionados (<span id="selectedCount">0</span>)
    </div>

    <!-- Modal Ranking -->
    <div id="rankingModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 id="rankingTitle">Ranking</h3>
                <i class="fas fa-times" onclick="closeModal()" style="cursor:pointer;"></i>
            </div>
            <div id="rankingContent"></div>
            
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                <label style="font-size:0.8rem; color:var(--text-secondary);">Registrar meu resultado:</label>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="myResultValue" class="search-input" placeholder="Ex: 12:30 ou 150kg" style="margin-bottom:0;">
                    <button class="btn-submit" onclick="saveResult()" style="margin-top:0; width:auto; padding:0 15px;">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <a href="perfil-social.html" class="nav-item"><i class="fas fa-home"></i></a>
        <a href="matches.html" class="nav-item"><i class="fas fa-heart"></i></a>
        <a href="desafios.html" class="nav-item active"><i class="fas fa-medal"></i></a>
    </nav>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token');
        let currentUserId = null;
        let allAthletes = [];
        let selectedChallengeId = null;

        if (!token) window.location.href = 'login.html';

        async function init() {
            await loadProfile();
            await loadAthletes();
            await loadChallenges();
        }

        async function loadProfile() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                currentUserId = data.id;
            } catch (err) { console.error('Erro perfil:', err); }
        }

        async function loadAthletes() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/participants-for-challenges`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    allAthletes = data.participants;
                    renderAthleteList(allAthletes);
                }
            } catch (err) { console.error('Erro atletas:', err); }
        }

        function renderAthleteList(list) {
            const container = document.getElementById('athleteList');
            container.innerHTML = list.map(a => `
                <div class="athlete-option" onclick="toggleAthlete(${a.id})">
                    <input type="checkbox" id="ath-${a.id}" value="${a.id}" onclick="event.stopPropagation()">
                    <img src="${formatPhoto(a.photo)}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                    <span>${a.name}</span>
                </div>
            `).join('');
        }

        function filterAthletes() {
            const term = document.getElementById('athleteSearch').value.toLowerCase();
            const filtered = allAthletes.filter(a => a.name.toLowerCase().includes(term));
            renderAthleteList(filtered);
        }

        function toggleAthlete(id) {
            const cb = document.getElementById(`ath-${id}`);
            if (cb) cb.checked = !cb.checked;
        }

        async function loadChallenges() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenges`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!data.success) {
                    document.getElementById('challengesList').innerHTML = `<div style="color:var(--error); padding:20px; text-align:center;">${data.error || 'Erro ao carregar desafios'}</div>`;
                    return;
                }

                renderChallenges(data.challenges);
            } catch (err) { 
                console.error('Erro desafios:', err);
                document.getElementById('challengesList').innerHTML = `<div style="color:var(--error); padding:20px; text-align:center;">Erro de conex√£o com o servidor.</div>`;
            }
        }

        function renderChallenges(challenges) {
            const container = document.getElementById('challengesList');
            if (challenges.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">Nenhum desafio ativo.</p>';
                return;
            }

            container.innerHTML = challenges.map(c => {
                const isCreator = c.creator_id === currentUserId;
                const isOpponent = c.opponent_id === currentUserId;
                const statusClass = `status-${c.status}`;
                const statusText = c.status === 'pending' ? 'Pendente' : (c.status === 'accepted' ? 'Aceito' : 'Recusado');

                return `
                    <div class="challenge-card">
                        ${isCreator ? `<input type="checkbox" class="challenge-checkbox" value="${c.id}" onchange="updateBulkUI()">` : ''}
                        ${isCreator ? `<i class="fas fa-trash delete-btn" onclick="deleteChallenge(${c.id})"></i>` : ''}
                        
                        <div class="challenge-header">
                            <span class="challenge-type">${c.challenge_type}</span>
                            <span style="font-size:0.7rem; color:#666;">Expira em: ${new Date(c.end_date).toLocaleDateString()}</span>
                        </div>

                        <div class="challenge-vs">
                            <div class="athlete-v">
                                <img src="${formatPhoto(c.creator_photo)}">
                                <span>${c.creator_name.split(' ')[0]}</span>
                            </div>
                            <div class="vs-circle">VS</div>
                            <div class="athlete-v">
                                <img src="${formatPhoto(c.opponent_photo)}">
                                <span>${c.opponent_name.split(' ')[0]}</span>
                            </div>
                        </div>

                        <div class="challenge-status ${statusClass}">
                            ${statusText} ${c.response_message ? `<br><small>"${c.response_message}"</small>` : ''}
                        </div>

                        <div class="challenge-actions">
                            ${isOpponent && c.status === 'pending' ? `
                                <button class="btn-action btn-accept" onclick="respondChallenge(${c.id}, 'accept')">Aceitar</button>
                                <button class="btn-action btn-reject" onclick="respondChallenge(${c.id}, 'reject')">Recusar</button>
                            ` : `
                                <button class="btn-action btn-ranking" onclick="openRanking(${c.id}, '${c.challenge_type}')">
                                    <i class="fas fa-trophy"></i> Ver Ranking
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function createChallenge() {
            const selectedIds = Array.from(document.querySelectorAll('#athleteList input:checked')).map(cb => parseInt(cb.value));
            const type = document.getElementById('challengeType').value;
            const duration = document.getElementById('challengeDuration').value;

            if (selectedIds.length === 0) return alert('Selecione pelo menos um oponente!');

            const btn = document.getElementById('btnCreate');
            btn.disabled = true;
            btn.innerText = 'Lan√ßando...';

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/create`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opponentIds: selectedIds, type, duration })
                });
                if (res.ok) {
                    alert('Desafio lan√ßado com sucesso!');
                    loadChallenges();
                    document.querySelectorAll('#athleteList input:checked').forEach(cb => cb.checked = false);
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Falha ao criar'));
                }
            } catch (err) { alert('Erro de conex√£o'); }
            finally {
                btn.disabled = false;
                btn.innerText = 'Lan√ßar Desafio! üöÄ';
            }
        }

        async function deleteChallenge(id) {
            if (!confirm('Deseja excluir este desafio?')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) loadChallenges();
                else {
                    const data = await res.json();
                    alert(data.error || 'Erro ao excluir');
                }
            } catch (err) { alert('Erro ao excluir'); }
        }

        async function respondChallenge(id, action) {
            const message = prompt('Mande um recado (opcional):', action === 'accept' ? 'Desafio aceito! Vou ganhar!' : 'Fica pra pr√≥xima!');
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${id}/respond`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, message })
                });
                if (res.ok) loadChallenges();
            } catch (err) { alert('Erro ao responder'); }
        }

        function updateBulkUI() {
            const selected = document.querySelectorAll('.challenge-checkbox:checked');
            const btn = document.getElementById('bulkDeleteBtn');
            const count = document.getElementById('selectedCount');
            
            if (selected.length > 0) {
                btn.style.display = 'block';
                count.innerText = selected.length;
            } else {
                btn.style.display = 'none';
            }
        }

        async function bulkDelete() {
            const ids = Array.from(document.querySelectorAll('.challenge-checkbox:checked')).map(cb => parseInt(cb.value));
            if (!confirm(`Excluir ${ids.length} desafios?`)) return;

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenges/bulk-delete`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ challengeIds: ids })
                });
                if (res.ok) {
                    loadChallenges();
                    document.getElementById('bulkDeleteBtn').style.display = 'none';
                }
            } catch (err) { alert('Erro na exclus√£o em massa'); }
        }

        async function openRanking(id, type) {
            selectedChallengeId = id;
            document.getElementById('rankingTitle').innerText = type;
            document.getElementById('rankingModal').style.display = 'flex';
            document.getElementById('rankingContent').innerHTML = 'Carregando ranking...';
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${id}/ranking`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    renderRanking(data.ranking);
                }
            } catch (err) { document.getElementById('rankingContent').innerHTML = 'Erro ao carregar ranking.'; }
        }

        function renderRanking(list) {
            const container = document.getElementById('rankingContent');
            if (list.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666;">Nenhum resultado registrado ainda.</p>';
                return;
            }
            container.innerHTML = list.map((item, idx) => `
                <div class="ranking-item">
                    <span class="ranking-pos">${idx + 1}¬∫</span>
                    <img src="${formatPhoto(item.photo)}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                    <span>${item.name}</span>
                    <span class="ranking-value">${item.result_value}</span>
                </div>
            `).join('');
        }

        async function saveResult() {
            const val = document.getElementById('myResultValue').value;
            if (!val) return alert('Insira seu resultado!');

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${selectedChallengeId}/result`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ result_value: val })
                });
                if (res.ok) {
                    alert('Resultado salvo!');
                    openRanking(selectedChallengeId, document.getElementById('rankingTitle').innerText);
                    document.getElementById('myResultValue').value = '';
                }
            } catch (err) { alert('Erro ao salvar resultado'); }
        }

        function closeModal() {
            document.getElementById('rankingModal').style.display = 'none';
        }

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image') || photo.startsWith('http')) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        init();
    </script>
</body>
</html>
