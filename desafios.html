<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WODPulse - Desafios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <link rel="stylesheet" href="social-style.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #121212; color: white; padding-bottom: 50px; }
        .challenge-container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .user-list { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; max-height: 300px; overflow-y: auto; padding-right: 10px; }
        .user-item { 
            background: #252525; padding: 15px; border-radius: 12px; 
            display: flex; align-items: center; gap: 15px; cursor: pointer;
            border: 2px solid transparent; transition: 0.3s;
        }
        .user-item.selected { border-color: #ff5722; background: #2d2d2d; }
        .user-item img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #333; }
        .challenge-form { background: #1e1e1e; padding: 20px; border-radius: 20px; margin-top: 20px; border: 1px solid #333; }
        select, input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #444; color: white; border-radius: 8px; font-size: 1rem; }
        .btn-challenge { width: 100%; padding: 15px; background: #ff5722; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn-challenge:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div class="challenge-container">
        <h1>üèÜ Criar Desafio</h1>
        <p style="color: #888;">Selecione um ou mais amigos para desafiar!</p>

        <div class="user-list" id="userList">
            <div style="text-align: center; padding: 20px;">Carregando atletas...</div>
        </div>

        <div class="challenge-form">
            <label>Tipo de Desafio:</label>
            <select id="challengeType">
                <option value="calories">üî• Mais Calorias Queimadas</option>
                <option value="points">‚≠ê Mais Queima Points</option>
                <option value="frequency">üìÖ Maior Frequ√™ncia Semanal</option>
            </select>

            <label>Dura√ß√£o (dias):</label>
            <input type="number" id="duration" value="7" min="1" max="30">

            <button class="btn-challenge" onclick="createChallenge()">Lan√ßar Desafio!</button>
        </div>

        <a href="perfil-social.html" style="display: block; text-align: center; margin-top: 20px; color: #ff5722; text-decoration: none; font-weight: 600;">
            <i class="fas fa-arrow-left"></i> Voltar ao Perfil
        </a>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token');
        let selectedUsers = [];

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/social/candidates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await response.json();
                const list = document.getElementById('userList');
                list.innerHTML = '';
                
                if (users.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum atleta encontrado.</div>';
                    return;
                }

                users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'user-item';
                    const photoUrl = user.photo || 'https://www.infrapower.com.br/logo-v6.png';
                    item.innerHTML = `
                        <img src="${photoUrl}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                        <div>
                            <strong>${user.name}</strong>
                            <p style="font-size: 0.8rem; color: #888; margin: 0;">Box ID: ${user.box_id || '--'}</p>
                        </div>
                    `;
                    item.onclick = () => toggleUser(user.id, item);
                    list.appendChild(item);
                });
            } catch (err) { 
                console.error(err); 
                document.getElementById('userList').innerHTML = '<div style="text-align: center; color: #ff4444;">Erro ao carregar lista.</div>';
            }
        }

        function toggleUser(id, element) {
            const index = selectedUsers.indexOf(id);
            if (index > -1) {
                selectedUsers.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedUsers.push(id);
                element.classList.add('selected');
            }
        }

        async function createChallenge() {
            if (selectedUsers.length === 0) return alert('Selecione pelo menos um atleta!');
            
            const type = document.getElementById('challengeType').value;
            const duration = document.getElementById('duration').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/social/challenge/create`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        opponentIds: selectedUsers, 
                        type, 
                        duration 
                    })
                });

                if (response.ok) {
                    alert('Desafio lan√ßado com sucesso! üöÄ');
                    window.location.href = 'perfil-social.html';
                } else {
                    alert('Erro ao criar desafio no servidor.');
                }
            } catch (err) { alert('Erro ao criar desafio.'); }
        }

        loadUsers();
    </script>
</body>
</html>
