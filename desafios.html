<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafios - WODPulse</title>
    <link rel="stylesheet" href="social_moderno.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="social_moderno.html" class="header-back-button"><i class="fas fa-arrow-left"></i></a>
            <div class="header-title">Desafios</div>
        </div>
    </header>

    <main class="main-content">
        <a href="criar_desafio.html" class="btn btn-primary btn-fullwidth">
            <i class="fas fa-plus-circle"></i> Criar Novo Desafio
        </a>

        <section class="profile-tabs" style="margin-top: 20px;">
            <button id="tabInProgress" class="tab-button active" onclick="showTab('inProgress' )">Em Andamento</button>
            <button id="tabInvitations" class="tab-button" onclick="showTab('invitations')">Convites</button>
            <button id="tabHistory" class="tab-button" onclick="showTab('history')">Histórico</button>
        </section>

        <section id="challengesContainer" class="challenges-list">
            <p style="text-align: center; padding: 40px; color: var(--secondary-text);">Carregando desafios...</p>
        </section>
    </main>

    <nav class="bottom-nav">
        <a href="social_moderno.html" class="nav-item" aria-label="Início"><i class="fas fa-home"></i></a>
        <a href="desafios.html" class="nav-item active" aria-label="Desafios"><i class="fas fa-trophy"></i></a>
        <a href="#" class="nav-item" aria-label="WOD Match"><i class="fas fa-fire"></i></a>
        <a href="notificacoes.html" class="nav-item" aria-label="Notificações"><i class="fas fa-bell"></i></a>
        <a href="perfil_moderno.html" class="nav-item" aria-label="Perfil"><i class="fas fa-user"></i></a>
    </nav>

    <!-- =================================== -->
    <!-- SCRIPT DE INTEGRAÇÃO DOS DESAFIOS -->
    <!-- =================================== -->
    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token' );
        const selfId = parseInt(localStorage.getItem('wodpulse_aluno_id'));

        if (!token || !selfId) {
            alert('Token ou ID do aluno não encontrado. Faça login novamente.');
            // window.location.href = 'login.html';
        }

        let allChallenges = []; // Armazena todos os desafios buscados
        let currentTab = 'inProgress'; // Aba ativa por padrão

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image' ) || photo.startsWith('http' )) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        /**
         * Renderiza os desafios na tela com base na aba ativa.
         */
        function renderChallenges() {
            const container = document.getElementById('challengesContainer');
            let challengesToRender = [];

            if (currentTab === 'inProgress') {
                challengesToRender = allChallenges.filter(c => c.status === 'accepted');
            } else if (currentTab === 'invitations') {
                // Mostra apenas convites que EU recebi (opponent_id é o meu id)
                challengesToRender = allChallenges.filter(c => c.status === 'pending' && c.opponent_id === selfId);
            } else if (currentTab === 'history') {
                challengesToRender = allChallenges.filter(c => ['completed', 'rejected', 'expired'].includes(c.status));
            }

            if (challengesToRender.length === 0) {
                let message = "Nenhum desafio aqui.";
                if (currentTab === 'invitations') message = "Nenhum convite pendente.";
                if (currentTab === 'inProgress') message = "Nenhum desafio em andamento. Que tal criar um?";
                container.innerHTML = `<p style="text-align: center; padding: 40px; color: var(--secondary-text);">${message}</p>`;
                return;
            }

            container.innerHTML = challengesToRender.map(challenge => {
                if (challenge.status === 'pending' && challenge.opponent_id === selfId) {
                    // Card de Convite
                    return `
                        <div class="challenge-card invitation">
                            <div class="challenge-header">
                                <span class="challenge-title"><strong>${challenge.creator_name}</strong> te desafiou!</span>
                            </div>
                            <div class="challenge-body-invitation">
                                <p><strong>Desafio:</strong> ${challenge.challenge_type.replace(/_/g, ' ')}</p>
                                <p><strong>Termina em:</strong> ${new Date(challenge.end_date).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div class="challenge-actions">
                                <button class="btn btn-primary" onclick="respondToChallenge(${challenge.id}, 'accept')">Aceitar</button>
                                <button class="btn btn-secondary" onclick="respondToChallenge(${challenge.id}, 'reject')">Recusar</button>
                            </div>
                        </div>
                    `;
                } else if (challenge.status === 'accepted') {
                    // Card de Desafio em Andamento
                    const timeLeft = Math.ceil((new Date(challenge.end_date) - new Date()) / (1000 * 60 * 60 * 24));
                    return `
                        <div class="challenge-card">
                            <div class="challenge-header">
                                <span class="challenge-title">${challenge.challenge_type.replace(/_/g, ' ')}</span>
                                <span class="challenge-time-left">${timeLeft > 0 ? `${timeLeft} dias restantes` : 'Terminou'}</span>
                            </div>
                            <div class="challenge-body">
                                <div class="competitor">
                                    <img src="${formatPhoto(challenge.creator_photo)}" alt="${challenge.creator_name}" class="profile-pic-small">
                                    <span>${challenge.creator_id === selfId ? 'Você' : challenge.creator_name.split(' ')[0]}</span>
                                    <!-- O score viria de outra chamada de API, por ex: /challenge/:id/ranking -->
                                    <strong class="competitor-score">...</strong>
                                </div>
                                <div class="vs-separator">vs</div>
                                <div class="competitor">
                                    <img src="${formatPhoto(challenge.opponent_photo)}" alt="${challenge.opponent_name}" class="profile-pic-small">
                                    <span>${challenge.opponent_id === selfId ? 'Você' : challenge.opponent_name.split(' ')[0]}</span>
                                    <strong class="competitor-score">...</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }
                // Cards de histórico podem ser adicionados aqui
                return '';
            }).join('');
        }

        /**
         * Altera a aba visível e renderiza novamente os desafios.
         */
        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            renderChallenges();
        }

        /**
         * Busca todos os desafios da API.
         */
        async function loadChallenges() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/challenges`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Falha ao buscar desafios.');
                
                const data = await res.json();
                allChallenges = data.challenges || [];
                renderChallenges(); // Renderiza a aba padrão (Em Andamento)

            } catch (err) {
                document.getElementById('challengesContainer').innerHTML = `<p style="text-align: center; padding: 40px; color: red;">${err.message}</p>`;
                console.error(err);
            }
        }

        /**
         * Responde a um convite de desafio.
         */
        async function respondToChallenge(challengeId, action) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/challenge/${challengeId}/respond`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: action })
                });

                if (!res.ok) throw new Error('Não foi possível responder ao desafio.');

                alert(`Desafio ${action === 'accept' ? 'aceito' : 'recusado'}!`);
                loadChallenges(); // Recarrega a lista para refletir a mudança

            } catch (err) {
                alert(err.message);
                console.error(err);
            }
        }

        // Inicia o carregamento da página
        loadChallenges();

    </script>

</body>
</html>
