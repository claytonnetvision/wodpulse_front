<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WODPulse - Desafios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        :root {
            --primary: #FF9800;
            --dark-bg: #0f0f0f;
            --card-bg: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --success: #4CAF50;
            --error: #f44336;
            --pending: #FFC107;
            --border-color: #333333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--dark-bg); color: var(--text-primary); font-family: 'Inter', sans-serif; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        .header h1 { font-size: 1.8rem; color: var(--primary); text-align: center; margin-bottom: 30px; }

        .create-challenge-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }

        .search-input {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid var(--border-color);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .athlete-selector {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .athlete-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        .athlete-option:hover { background: #333; }
        .athlete-option input { accent-color: var(--primary); }
        .athlete-option img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        .btn-submit {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
        }

        .challenge-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .challenge-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
        }

        .delete-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .delete-btn:hover { color: var(--error); }

        .challenge-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }

        .challenge-type {
            background: rgba(255, 152, 0, 0.2);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .challenge-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .athlete-v {
            text-align: center;
            flex: 1;
        }
        .athlete-v img { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--border-color); }
        .athlete-v strong { display: block; margin-top: 8px; }

        .vs-circle {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: black;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }

        .challenge-status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
            margin: 15px 0;
        }
        .status-pending { background: rgba(255, 193, 7, 0.2); color: var(--pending); }
        .status-accepted { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .status-rejected { background: rgba(244, 67, 54, 0.2); color: var(--error); }

        .result-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .result-input-group input {
            flex: 1;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: white;
        }

        .challenge-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-action {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-accept { background: var(--success); color: white; }
        .btn-reject { background: var(--error); color: white; }
        .btn-ranking { background: #333; color: white; }

        /* Bulk Delete */
        .bulk-actions {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .bulk-actions button {
            background: var(--error);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Modal Ranking */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .ranking-pos { font-size: 1.5rem; font-weight: bold; color: var(--primary); width: 40px; }
        .ranking-item img { width: 40px; height: 40px; border-radius: 50%; }
        .ranking-value { margin-left: auto; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-trophy"></i> Desafios</h1>
        </div>

        <!-- CriaÃ§Ã£o de Desafio -->
        <div class="create-challenge-card">
            <h2 style="margin-bottom: 20px; color: var(--primary);">LanÃ§ar Novo Desafio</h2>
            
            <div class="form-group">
                <label>Tipo de Desafio</label>
                <select id="challengeType" class="search-input">
                    <option value="amrap">AMRAP (mais rounds/reps)</option>
                    <option value="for_time">For Time (menor tempo)</option>
                    <option value="max_reps">Max Reps</option>
                    <option value="murph">Murph Time</option>
                </select>
            </div>

            <div class="form-group">
                <label>DuraÃ§Ã£o (dias)</label>
                <input type="number" id="durationDays" class="search-input" value="7" min="1">
            </div>

            <div class="form-group">
                <label>Oponentes (selecione quantos quiser)</label>
                <input type="text" id="searchAthletes" class="search-input" placeholder="Buscar por nome...">
                <div class="athlete-selector" id="athleteList"></div>
            </div>

            <button class="btn-submit" id="btnCreate" onclick="createChallenge()">LanÃ§ar Desafio! ðŸš€</button>
        </div>

        <!-- Lista de Desafios -->
        <div id="challengesList">
            <p style="text-align:center; color:#666;">Carregando desafios...</p>
        </div>

        <!-- Bulk Delete -->
        <div class="bulk-actions" id="bulkDeleteBtn">
            <span>Selecionados: <strong id="selectedCount">0</strong></span>
            <button onclick="bulkDelete()">Excluir Selecionados</button>
        </div>
    </div>

    <!-- Modal Ranking -->
    <div class="modal" id="rankingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rankingTitle">Ranking</h2>
                <i class="fas fa-times" style="font-size:1.5rem; cursor:pointer;" onclick="closeModal()"></i>
            </div>
            <div id="rankingContent">
                Carregando...
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token');
        if (!token) window.location.href = 'login.html';

        let currentUserId = null;
        let participants = [];

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image') || photo.startsWith('http')) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        async function init() {
            // Carrega ID do usuÃ¡rio logado
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                currentUserId = data.id;
            } catch (err) {
                alert('Erro ao carregar perfil');
                return;
            }

            await loadParticipants();
            await loadChallenges();

            // Filtro de busca em tempo real
            document.getElementById('searchAthletes').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const list = document.getElementById('athleteList');
                list.innerHTML = participants
                    .filter(p => p.name.toLowerCase().includes(term))
                    .map(p => `
                        <div class="athlete-option">
                            <input type="checkbox" value="${p.id}">
                            <img src="${formatPhoto(p.photo)}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                            <span>${p.name}</span>
                        </div>
                    `).join('');
            });
        }

        async function loadParticipants() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/participants-for-challenges`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                participants = data.participants || [];

                // Render inicial
                document.getElementById('athleteList').innerHTML = participants.map(p => `
                    <div class="athlete-option">
                        <input type="checkbox" value="${p.id}">
                        <img src="${formatPhoto(p.photo)}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                        <span>${p.name}</span>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('athleteList').innerHTML = '<p style="color:#f44336;">Erro ao carregar atletas</p>';
            }
        }

        async function loadChallenges() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenges`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const container = document.getElementById('challengesList');
                if (!data.challenges || data.challenges.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#888;">Nenhum desafio no momento. Lance um!</p>';
                    return;
                }

                container.innerHTML = data.challenges.map(c => {
                    const isCreator = c.creator_id === currentUserId;
                    const isOpponent = c.opponent_id === currentUserId;

                    let actions = '';
                    if (isCreator && c.status === 'pending') {
                        actions += `<i class="fas fa-trash delete-btn" onclick="deleteChallenge(${c.id})"></i>`;
                    }
                    if (isOpponent && c.status === 'pending') {
                        actions += `
                            <div class="challenge-actions">
                                <button class="btn-action btn-accept" onclick="respondChallenge(${c.id}, 'accept')">Aceitar</button>
                                <button class="btn-action btn-reject" onclick="respondChallenge(${c.id}, 'reject')">Recusar</button>
                            </div>`;
                    }
                    if (c.status === 'accepted') {
                        actions += `
                            <div class="result-input-group">
                                <input type="text" placeholder="Seu resultado (ex: 12:45 ou 250)" id="result-${c.id}">
                                <button class="btn-action" onclick="submitResult(${c.id})">Enviar</button>
                            </div>
                            <div class="challenge-actions">
                                <button class="btn-action btn-ranking" onclick="openRanking(${c.id}, '${c.challenge_type.toUpperCase()}')">
                                    <i class="fas fa-trophy"></i> Ver Ranking
                                </button>
                            </div>`;
                    }

                    const statusClass = `status-${c.status}`;
                    const statusText = c.status === 'pending' ? 'Pendente' : c.status === 'accepted' ? 'Aceito' : 'Recusado';

                    return `
                        <div class="challenge-card">
                            <input type="checkbox" class="challenge-checkbox" value="${c.id}" onchange="updateBulkUI()">
                            ${actions}
                            <div class="challenge-header">
                                <span class="challenge-type">${c.challenge_type.toUpperCase()}</span>
                            </div>
                            <div class="challenge-vs">
                                <div class="athlete-v">
                                    <img src="${formatPhoto(c.creator_photo)}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                                    <strong>${c.creator_name}</strong>
                                </div>
                                <div class="vs-circle">VS</div>
                                <div class="athlete-v">
                                    <img src="${formatPhoto(c.opponent_photo)}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                                    <strong>${c.opponent_name}</strong>
                                </div>
                            </div>
                            <div class="challenge-status ${statusClass}">
                                ${statusText} â€¢ AtÃ© ${new Date(c.end_date).toLocaleDateString('pt-BR')}
                            </div>
                        </div>`;
                }).join('');
                
                updateBulkUI();
            } catch (err) {
                container.innerHTML = '<p style="color:#f44336;">Erro ao carregar desafios</p>';
            }
        }

        async function createChallenge() {
            const type = document.getElementById('challengeType').value;
            const duration = document.getElementById('durationDays').value;
            const selected = document.querySelectorAll('#athleteList input:checked');
            const opponentIds = Array.from(selected).map(cb => parseInt(cb.value));

            if (opponentIds.length === 0) return alert('Selecione pelo menos um oponente!');

            const btn = document.getElementById('btnCreate');
            btn.disabled = true;
            btn.innerText = 'LanÃ§ando...';

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/create`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opponentIds, type, duration })
                });
                if (res.ok) {
                    alert('Desafios lanÃ§ados com sucesso!');
                    selected.forEach(cb => cb.checked = false);
                    loadChallenges();
                } else {
                    const err = await res.json();
                    alert('Erro: ' + (err.error || 'Tente novamente'));
                }
            } catch (err) {
                alert('Erro de conexÃ£o');
            } finally {
                btn.disabled = false;
                btn.innerText = 'LanÃ§ar Desafio! ðŸš€';
            }
        }

        async function deleteChallenge(id) {
            if (!confirm('Excluir este desafio?')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) loadChallenges();
            } catch (err) { alert('Erro ao excluir'); }
        }

        async function respondChallenge(id, action) {
            const message = prompt('Mensagem opcional:', action === 'accept' ? 'Bora!' : 'NÃ£o dÃ¡ dessa vez');
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${id}/respond`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, message: message || '' })
                });
                if (res.ok) loadChallenges();
            } catch (err) { alert('Erro ao responder'); }
        }

        async function submitResult(challengeId) {
            const input = document.getElementById(`result-${challengeId}`);
            const value = input.value.trim();
            if (!value) return alert('Digite seu resultado!');

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${challengeId}/result`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ result_value: value })
                });
                if (res.ok) {
                    alert('Resultado enviado!');
                    input.value = '';
                    loadChallenges(); // atualiza status/visual
                }
            } catch (err) { alert('Erro ao enviar resultado'); }
        }

        function updateBulkUI() {
            const selected = document.querySelectorAll('.challenge-checkbox:checked').length;
            const bulkBtn = document.getElementById('bulkDeleteBtn');
            document.getElementById('selectedCount').innerText = selected;
            bulkBtn.style.display = selected > 0 ? 'block' : 'none';
        }

        async function bulkDelete() {
            const ids = Array.from(document.querySelectorAll('.challenge-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            if (!confirm(`Excluir ${ids.length} desafios?`)) return;

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenges/bulk-delete`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ challengeIds: ids })
                });
                if (res.ok) {
                    loadChallenges();
                    updateBulkUI();
                }
            } catch (err) { alert('Erro na exclusÃ£o'); }
        }

        async function openRanking(id, typeTitle) {
            document.getElementById('rankingTitle').innerText = typeTitle;
            document.getElementById('rankingModal').style.display = 'flex';
            document.getElementById('rankingContent').innerHTML = '<p style="text-align:center;">Carregando...</p>';

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/challenge/${id}/ranking`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success && data.ranking.length > 0) {
                    document.getElementById('rankingContent').innerHTML = data.ranking.map((r, i) => `
                        <div class="ranking-item">
                            <span class="ranking-pos">${i + 1}Âº</span>
                            <img src="${formatPhoto(r.photo)}" onerror="this.src='https://www.infrapower.com.br/logo-v6.png'">
                            <strong>${r.name}</strong>
                            <span class="ranking-value">${r.result_value}</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('rankingContent').innerHTML = '<p style="text-align:center; color:#888;">Nenhum resultado ainda.</p>';
                }
            } catch (err) {
                document.getElementById('rankingContent').innerHTML = '<p style="color:#f44336;">Erro ao carregar</p>';
            }
        }

        function closeModal() {
            document.getElementById('rankingModal').style.display = 'none';
        }

        // Atualiza a cada 30s
        setInterval(loadChallenges, 30000);

        // Inicia tudo
        init();
    </script>
</body>
</html>