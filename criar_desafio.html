<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Criar Desafio - WODPulse</title>
    <link rel="stylesheet" href="style_tinder.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <a href="javascript:history.back( )" class="header-btn"><i class="fas fa-arrow-left"></i></a>
            <div class="logo-tinder">Criar Desafio</div>
            <div class="header-btn" style="width: 40px;"></div>
        </header>

        <main class="form-container">
            <div class="form-group">
                <label for="challengeTitle">Nome do Desafio:</label>
                <input type="text" id="challengeTitle" value="Queima de Calorias Semanal">
            </div>

            <div class="form-group">
                <label for="challengeType">Tipo de Desafio:</label>
                <select id="challengeType">
                    <option value="calories" selected>Queima de Calorias</option>
                </select>
            </div>

            <div class="form-group-row">
                <div class="form-group">
                    <label for="startDate">Data de Início:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">Data de Fim:</label>
                    <input type="date" id="endDate">
                </div>
            </div>

            <div class="form-group">
                <label>Convidar Amigos:</label>
                <div id="friendsList" class="friends-list-container">
                    <p class="loading-text">Carregando amigos...</p>
                </div>
            </div>

            <button id="createChallengeButton" class="btn-action-primary">Criar e Enviar Convites</button>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token' );
        const urlParams = new URLSearchParams(window.location.search);
        const preselectedOpponentId = urlParams.get('opponentId');

        if (!token) {
            alert('Sessão não encontrada. Faça login.');
            window.location.href = 'login_tinder.html';
        }

        const today = new Date();
        const nextWeek = new Date();
        nextWeek.setDate(today.getDate() + 7);
        document.getElementById('startDate').value = today.toISOString().split('T')[0];
        document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];

        async function loadFriends() {
            const friendsContainer = document.getElementById('friendsList');
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friends`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const friends = data.confirmedFriends || [];

                if (friends.length === 0) {
                    friendsContainer.innerHTML = '<p class="loading-text">Você não tem amigos para desafiar ainda.</p>';
                    return;
                }

                friendsContainer.innerHTML = friends.map(friend => {
                    const isPreselected = String(friend.id) === String(preselectedOpponentId);
                    return `
                        <div class="friend-item-checkbox">
                            <input type="checkbox" id="friend-${friend.id}" value="${friend.id}" ${isPreselected ? 'checked' : ''}>
                            <label for="friend-${friend.id}">
                                <img src="${friend.photo ? `data:image/jpeg;base64,${friend.photo}` : 'https://i.imgur.com/3g7A8vW.png'}" alt="${friend.name}">
                                <span>${friend.name}</span>
                            </label>
                        </div>
                    `;
                } ).join('');
            } catch (err) {
                console.error('Erro ao carregar amigos:', err);
                friendsContainer.innerHTML = '<p class="loading-text" style="color:red;">Erro ao carregar amigos.</p>';
            }
        }

        document.getElementById('createChallengeButton').addEventListener('click', async () => {
            const title = document.getElementById('challengeTitle').value;
            const type = document.getElementById('challengeType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            const selectedFriends = document.querySelectorAll('#friendsList input[type="checkbox"]:checked');
            const invitedParticipants = Array.from(selectedFriends).map(cb => cb.value);

            if (!title || !startDate || !endDate || invitedParticipants.length === 0) {
                alert('Por favor, preencha todos os campos e selecione pelo menos um amigo.');
                return;
            }

            try {
                // CHAMADA REAL PARA A API
                const res = await fetch(`${API_BASE_URL}/api/challenges/create`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, startDate, endDate, invitedParticipants })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Falha ao criar desafio.');
                }

                const result = await res.json();
                alert('Desafio criado com sucesso! Você será redirecionado para o painel.');
                // Redireciona para a futura página do painel do desafio
                // window.location.href = `desafio_painel.html?id=${result.challengeId}`;
                
            } catch (err) {
                console.error('Erro ao criar desafio:', err);
                alert(`Erro ao criar desafio: ${err.message}`);
            }
        });

        loadFriends();
    </script>
</body>
</html>
