<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WODPulse - Orkut Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        :root {
            --orkut-blue: #EDF3FD;
            --orkut-header: #BFD0EA;
            --orkut-sidebar: #D9E6F7;
            --orkut-pink: #FF0084;
            --orkut-text: #333;
            --orkut-border: #C5D5F0;
            --orkut-dark-blue: #6D84B4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: var(--orkut-blue);
            color: var(--orkut-text);
            font-size: 12px;
        }

        /* HEADER */
        header {
            background-color: white;
            border-bottom: 1px solid var(--orkut-border);
            padding: 5px 0;
        }

        .header-container {
            max-width: 950px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--orkut-pink);
            text-decoration: none;
        }

        .nav-top a {
            color: var(--orkut-dark-blue);
            text-decoration: none;
            margin-left: 15px;
            font-weight: bold;
        }

        /* MAIN LAYOUT */
        .main-container {
            max-width: 950px;
            margin: 15px auto;
            display: grid;
            grid-template-columns: 180px 1fr 250px;
            gap: 15px;
        }

        /* SIDEBAR LEFT */
        .sidebar-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-box {
            background: white;
            border: 1px solid var(--orkut-border);
            padding: 10px;
            text-align: center;
        }

        .profile-pic-large {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .profile-name {
            font-weight: bold;
            color: var(--orkut-dark-blue);
            margin-bottom: 5px;
            display: block;
        }

        .menu-list {
            list-style: none;
            text-align: left;
            margin-top: 10px;
        }

        .menu-list li {
            padding: 3px 0;
        }

        .menu-list a {
            color: var(--orkut-dark-blue);
            text-decoration: none;
        }

        .menu-list a:hover { text-decoration: underline; }

        /* CENTER CONTENT */
        .content-center {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .box {
            background: white;
            border: 1px solid var(--orkut-border);
            padding: 15px;
        }

        .box-header {
            background: var(--orkut-header);
            padding: 5px 10px;
            font-weight: bold;
            color: var(--orkut-dark-blue);
            margin: -15px -15px 15px -15px;
            display: flex;
            justify-content: space-between;
        }

        /* FEED / POSTS */
        .post-input-area {
            margin-bottom: 15px;
        }

        .post-input-area textarea {
            width: 100%;
            height: 60px;
            border: 1px solid var(--orkut-border);
            padding: 8px;
            margin-bottom: 5px;
            resize: none;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-post {
            background: var(--orkut-dark-blue);
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        .feed-item {
            border-bottom: 1px dotted #ccc;
            padding: 10px 0;
            display: flex;
            gap: 10px;
        }

        .feed-item:last-child { border-bottom: none; }

        .feed-photo {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }

        .feed-content strong { color: var(--orkut-dark-blue); }

        /* SIDEBAR RIGHT */
        .sidebar-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .friend-item {
            text-align: center;
            font-size: 10px;
            cursor: pointer;
        }

        .friend-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #ccc;
        }

        .friend-item span {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--orkut-dark-blue);
        }

        /* SEARCH SECTION */
        .search-box {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--orkut-border);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border: 5px solid var(--orkut-header);
            width: 400px;
        }

        /* UTILS */
        .pink { color: var(--orkut-pink); }
        .blue { color: var(--orkut-dark-blue); }
        .hidden { display: none; }

    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <a href="#" class="logo">orkut <span style="font-weight: normal; font-size: 14px; color: #666;">WODPulse</span></a>
            <nav class="nav-top">
                <a href="orkut-social.html">Início</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </div>
    </header>

    <div class="main-container">
        
        <!-- COLUNA ESQUERDA -->
        <aside class="sidebar-left">
            <div class="profile-box">
                <img id="userPhotoLarge" class="profile-pic-large" src="https://www.infrapower.com.br/logo-v6.png" alt="Foto">
                <span id="userName" class="profile-name">Carregando...</span>
                <p id="userBio" style="font-size: 11px; color: #666;"></p>
                
                <ul class="menu-list">
                    <li><a href="#" onclick="openEditModal()"><i class="fas fa-edit"></i> Editar Perfil</a></li>
                    <li><a href="#" onclick="showSection('feed')"><i class="fas fa-rss"></i> Feed</a></li>
                    <li><a href="#" onclick="showSection('scraps')"><i class="fas fa-envelope"></i> Mural (Scraps)</a></li>
                    <li><a href="#" onclick="showSection('photos')"><i class="fas fa-camera"></i> Fotos</a></li>
                    <li><a href="matches.html"><i class="fas fa-heart"></i> Matches</a></li>
                    <li><a href="desafios.html"><i class="fas fa-trophy"></i> Desafios</a></li>
                </ul>
            </div>

            <div class="box">
                <div class="box-header">Estatísticas</div>
                <p>Desafios: <strong id="stat-challenges" class="pink">0</strong></p>
                <p>Likes: <strong id="stat-likes" class="pink">0</strong></p>
                <p>Matches: <strong id="stat-matches" class="pink">0</strong></p>
            </div>
        </aside>

        <!-- COLUNA CENTRAL -->
        <main class="content-center">
            
            <!-- BUSCA -->
            <div class="box search-box">
                <div class="box-header">Procurar Atletas</div>
                <input type="text" id="searchUsersInput" class="search-input" placeholder="Digite o nome do atleta...">
                <div id="searchResults" style="margin-top: 10px;"></div>
            </div>

            <!-- FEED / MURAL / FOTOS (DINÂMICO) -->
            <div id="main-content-box" class="box">
                <div id="content-title" class="box-header">Feed de Notícias</div>
                
                <!-- ÁREA DE POSTAGEM -->
                <div id="post-area" class="post-input-area">
                    <textarea id="postInput" placeholder="O que você está treinando hoje?"></textarea>
                    <div class="post-actions">
                        <select id="postPrivacy">
                            <option value="public">Público</option>
                            <option value="friends">Só Amigos</option>
                            <option value="private">Privado</option>
                        </select>
                        <button class="btn-post" onclick="createPost()">Postar</button>
                    </div>
                </div>

                <div id="dynamic-list">
                    <!-- Conteúdo carregado via JS -->
                    <p style="text-align: center; color: #888;">Carregando conteúdo...</p>
                </div>
            </div>
        </main>

        <!-- COLUNA DIREITA -->
        <aside class="sidebar-right">
            <div class="box">
                <div class="box-header">
                    Meus Amigos <span id="friendsCount">(0)</span>
                </div>
                <div id="friendsGrid" class="friends-grid">
                    <!-- Amigos via JS -->
                </div>
                <a href="#" style="display: block; margin-top: 10px; text-align: right; color: var(--orkut-dark-blue);">ver todos</a>
            </div>

            <div class="box">
                <div class="box-header">Pedidos de Amizade</div>
                <div id="pendingRequests">
                    <p style="font-size: 11px; color: #888;">Nenhum pedido.</p>
                </div>
            </div>
        </aside>

    </div>

    <!-- MODAL EDIÇÃO -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 class="blue">Editar Perfil</h3>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
            <p>Bio:</p>
            <textarea id="bioInput" style="width: 100%; height: 80px; margin-bottom: 10px;"></textarea>
            <p>Foto de Capa (URL):</p>
            <input type="text" id="coverInput" style="width: 100%; margin-bottom: 15px;">
            <div style="text-align: right;">
                <button class="btn-post" onclick="saveProfile()">Salvar</button>
                <button onclick="closeEditModal()" style="padding: 5px 10px;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token');
        let currentSection = 'feed';
        let userData = null;

        if (!token) window.location.href = 'login.html';

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image') || photo.startsWith('http')) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        async function loadProfile() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                userData = await res.json();
                
                document.getElementById('userPhotoLarge').src = formatPhoto(userData.photo);
                document.getElementById('userName').textContent = userData.name || 'Atleta';
                document.getElementById('userBio').textContent = userData.bio || 'Sem bio definida.';
                
                document.getElementById('stat-challenges').textContent = userData.stats?.challenges || 0;
                document.getElementById('stat-likes').textContent = userData.stats?.likes || 0;
                document.getElementById('stat-matches').textContent = userData.stats?.matches || 0;

                loadFriends();
                loadContent();
            } catch (err) {
                console.error('Erro ao carregar perfil:', err);
            }
        }

        async function loadFriends() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friends`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                // Amigos
                const grid = document.getElementById('friendsGrid');
                document.getElementById('friendsCount').textContent = `(${data.confirmedFriends?.length || 0})`;
                if (data.confirmedFriends?.length > 0) {
                    grid.innerHTML = data.confirmedFriends.slice(0, 9).map(f => `
                        <div class="friend-item" onclick="openProfile(${f.id})">
                            <img src="${formatPhoto(f.photo)}">
                            <span>${f.name.split(' ')[0]}</span>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p style="grid-column: 1/-1; color: #888;">Nenhum amigo.</p>';
                }

                // Pedidos
                const pending = document.getElementById('pendingRequests');
                if (data.pendingRequests?.length > 0) {
                    pending.innerHTML = data.pendingRequests.map(req => `
                        <div style="margin-bottom: 10px; font-size: 11px;">
                            <strong>${req.name}</strong> quer ser seu amigo.
                            <br>
                            <a href="#" onclick="respondFriend(${req.id}, 'accept')" class="blue">Aceitar</a> | 
                            <a href="#" onclick="respondFriend(${req.id}, 'reject')" class="pink">Recusar</a>
                        </div>
                    `).join('');
                }
            } catch (err) {}
        }

        function showSection(section) {
            currentSection = section;
            const title = document.getElementById('content-title');
            const postArea = document.getElementById('post-area');
            
            if (section === 'feed') {
                title.textContent = 'Feed de Notícias';
                postArea.classList.remove('hidden');
            } else if (section === 'scraps') {
                title.textContent = 'Mural de Recados (Scraps)';
                postArea.classList.remove('hidden');
                document.getElementById('postInput').placeholder = 'Deixe um scrap...';
            } else if (section === 'photos') {
                title.textContent = 'Álbum de Fotos';
                postArea.classList.add('hidden');
            }
            loadContent();
        }

        // Simulação de Feed/Scraps já que não existem rotas específicas no back ainda
        // Mas usaremos o localStorage para persistir localmente e demonstrar a funcionalidade
        function loadContent() {
            const list = document.getElementById('dynamic-list');
            let content = JSON.parse(localStorage.getItem(`wodpulse_${currentSection}`) || '[]');
            
            if (content.length === 0) {
                list.innerHTML = `<p style="text-align: center; color: #888; padding: 20px;">Nenhum ${currentSection} para mostrar.</p>`;
                return;
            }

            list.innerHTML = content.map(item => `
                <div class="feed-item">
                    <img src="${item.userPhoto}" class="feed-photo">
                    <div class="feed-content">
                        <strong>${item.userName}</strong> <span style="color: #999; font-size: 10px;">${item.date}</span>
                        <p style="margin-top: 5px;">${item.text}</p>
                    </div>
                </div>
            `).reverse().join('');
        }

        function createPost() {
            const text = document.getElementById('postInput').value.trim();
            if (!text) return;

            const newPost = {
                userName: userData.name,
                userPhoto: formatPhoto(userData.photo),
                text: text,
                date: new Date().toLocaleString(),
                privacy: document.getElementById('postPrivacy').value
            };

            let content = JSON.parse(localStorage.getItem(`wodpulse_${currentSection}`) || '[]');
            content.push(newPost);
            localStorage.setItem(`wodpulse_${currentSection}`, JSON.stringify(content));

            document.getElementById('postInput').value = '';
            loadContent();
        }

        // BUSCA DE USUÁRIOS (Mantendo lógica original)
        let searchTimeout;
        document.getElementById('searchUsersInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            searchTimeout = setTimeout(() => searchUsers(query), 500);
        });

        async function searchUsers(query) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/search-users?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const container = document.getElementById('searchResults');
                if (data.users.length === 0) {
                    container.innerHTML = '<p style="color:#888;">Nenhum atleta encontrado.</p>';
                    return;
                }
                container.innerHTML = data.users.map(user => `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 5px; border-bottom: 1px solid #eee;">
                        <img src="${formatPhoto(user.photo)}" style="width: 30px; height: 30px; object-fit: cover;">
                        <div style="flex: 1;">
                            <strong class="blue" style="cursor:pointer" onclick="openProfile(${user.id})">${user.name}</strong>
                            <div style="font-size: 10px; color: #999;">Box: ${user.box_id || '--'}</div>
                        </div>
                        <button onclick="requestFriendship(${user.id})" style="font-size: 10px;">Add</button>
                    </div>
                `).join('');
            } catch (err) {}
        }

        async function requestFriendship(targetId) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friend/request`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetId })
                });
                const data = await res.json();
                alert(data.message || 'Pedido enviado!');
            } catch (err) { alert('Erro ao enviar pedido'); }
        }

        async function respondFriend(requesterId, action) {
            try {
                await fetch(`${API_BASE_URL}/api/social/friend/respond`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requesterId, action })
                });
                loadFriends();
            } catch (err) {}
        }

        function openProfile(userId) {
            window.location.href = `perfil-participante.html?id=${userId}`;
        }

        function openEditModal() {
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('bioInput').value = userData.bio || '';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function saveProfile() {
            const bio = document.getElementById('bioInput').value.trim();
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/profile/update`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bio: bio })
                });
                if (res.ok) {
                    alert('Perfil atualizado!');
                    closeEditModal();
                    loadProfile();
                }
            } catch (err) { alert('Erro ao salvar'); }
        }

        function logout() {
            if (confirm('Sair do Orkut WODPulse?')) {
                localStorage.removeItem('wodpulse_social_token');
                window.location.href = 'login.html';
            }
        }

        loadProfile();
    </script>
</body>
</html>
