<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WODPulse - Orkut Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        :root {
            --orkut-blue: #EDF3FD;
            --orkut-header: #BFD0EA;
            --orkut-pink: #FF0084;
            --orkut-text: #333;
            --orkut-border: #C5D5F0;
            --orkut-dark-blue: #6D84B4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: var(--orkut-blue);
            color: var(--orkut-text);
            font-size: 12px;
        }

        header {
            background-color: white;
            border-bottom: 1px solid var(--orkut-border);
            padding: 5px 0;
        }

        .header-container {
            max-width: 950px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--orkut-pink);
            text-decoration: none;
        }

        .nav-top a {
            color: var(--orkut-dark-blue);
            text-decoration: none;
            margin-left: 15px;
            font-weight: bold;
        }

        .main-container {
            max-width: 950px;
            margin: 15px auto;
            display: grid;
            grid-template-columns: 180px 1fr 250px;
            gap: 15px;
        }

        .sidebar-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-box {
            background: white;
            border: 1px solid var(--orkut-border);
            padding: 10px;
            text-align: center;
        }

        .profile-pic-large {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .profile-name {
            font-weight: bold;
            color: var(--orkut-dark-blue);
            margin-bottom: 5px;
            display: block;
        }

        .menu-list {
            list-style: none;
            text-align: left;
            margin-top: 10px;
        }

        .menu-list li {
            padding: 3px 0;
        }

        .menu-list a {
            color: var(--orkut-dark-blue);
            text-decoration: none;
        }

        .menu-list a:hover { text-decoration: underline; }

        .stats-widget {
            background: #fff;
            border: 1px solid var(--orkut-border);
            padding: 10px;
            margin-top: 10px;
            text-align: left;
        }

        .stats-widget-header {
            font-weight: bold;
            color: var(--orkut-dark-blue);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 8px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
        }

        .stat-label { color: #666; }
        .stat-value { font-weight: bold; color: var(--orkut-pink); }

        .motivational-box {
            background: #fff8e1;
            border: 1px solid #ffe082;
            padding: 8px;
            margin-top: 10px;
            font-size: 10px;
            color: #795548;
            border-radius: 4px;
            line-height: 1.4;
        }

        .content-center {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .box {
            background: white;
            border: 1px solid var(--orkut-border);
            padding: 15px;
        }

        .box-header {
            background: var(--orkut-header);
            padding: 5px 10px;
            font-weight: bold;
            color: var(--orkut-dark-blue);
            margin: -15px -15px 15px -15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-input-area {
            margin-bottom: 15px;
            position: relative;
        }

        .post-input-wrapper {
            position: relative;
        }

        .post-input-area textarea {
            width: 100%;
            height: 60px;
            border: 1px solid var(--orkut-border);
            padding: 8px;
            margin-bottom: 5px;
            resize: none;
            font-family: Arial, sans-serif;
        }

        .mention-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            display: none;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .mention-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }

        .mention-item:hover {
            background: #f5f5f5;
        }

        .mention-item strong {
            color: var(--orkut-dark-blue);
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-post {
            background: var(--orkut-dark-blue);
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-icon {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

        .btn-icon:hover { background: #e0e0e0; }

        .feed-item {
            border-bottom: 1px dotted #ccc;
            padding: 10px 0;
            position: relative;
        }

        .feed-item:last-child { border-bottom: none; }

        .feed-header {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: flex-start;
            justify-content: space-between;
        }

        .feed-header-left {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            flex: 1;
        }

        .feed-photo-small {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            cursor: pointer;
        }

        .feed-info {
            flex: 1;
        }

        .feed-author {
            font-weight: bold;
            color: var(--orkut-dark-blue);
            cursor: pointer;
        }

        .feed-author:hover {
            text-decoration: underline;
        }

        .feed-time {
            color: #999;
            font-size: 10px;
        }

        .feed-content {
            margin: 8px 0;
            line-height: 1.4;
        }

        .feed-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            margin: 8px 0;
            border: 1px solid #ddd;
        }

        .feed-reactions {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 11px;
            justify-content: space-between;
            align-items: center;
        }

        .reaction-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .reaction-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            gap: 3px;
            transition: color 0.2s;
            padding: 3px 8px;
            border-radius: 3px;
        }

        .reaction-btn:hover { color: var(--orkut-pink); background: #f5f5f5; }
        .reaction-btn.active { color: var(--orkut-pink); font-weight: bold; background: #fff0f6; }

        .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 14px;
            padding: 3px 8px;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .delete-btn:hover { color: #ff6b6b; background: #fff5f5; border-radius: 3px; }

        .sidebar-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .match-sidebar-card {
            text-align: center;
            padding: 10px;
        }

        .match-photo-small {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .match-actions-mini {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .btn-match-mini {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.2s;
        }

        .btn-match-mini:hover { transform: scale(1.1); }
        .btn-pass { background: #f0f0f0; color: #999; }
        .btn-like { background: var(--orkut-pink); color: white; }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .friend-item {
            text-align: center;
            font-size: 10px;
            cursor: pointer;
        }

        .friend-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #ccc;
        }

        .friend-item span {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--orkut-dark-blue);
            margin-top: 2px;
        }

        .search-input {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--orkut-border);
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            width: 400px;
            border-radius: 5px;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: var(--orkut-pink);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            display: none;
        }

        .pink { color: var(--orkut-pink); }
        .blue { color: var(--orkut-dark-blue); }
    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <a href="#" class="logo">orkut <span style="font-weight: normal; font-size: 14px; color: #666;">WODPulse</span></a>
            <nav class="nav-top">
                <a href="orkut-social.html">In√≠cio</a>
                <a href="matches-list.html"><i class="fas fa-heart"></i> Matches</a>
                <a href="#" onclick="toggleNotifications()" style="position: relative;">
                    <i class="fas fa-bell"></i> Notifica√ß√µes
                    <span id="notificationBadge" class="notification-badge">0</span>
                </a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </div>
    </header>

    <div class="main-container">
        
        <aside class="sidebar-left">
            <div class="profile-box">
                <img id="userPhotoLarge" class="profile-pic-large" src="https://www.infrapower.com.br/logo-v6.png" alt="Foto">
                <span id="userName" class="profile-name">Carregando...</span>
                <p id="userBio" style="font-size: 11px; color: #666;"></p>
                
                <ul class="menu-list">
                    <li><a href="#" onclick="openEditModal()"><i class="fas fa-edit"></i> Editar Perfil</a></li>
                    <li><a href="#" onclick="showSection('feed')"><i class="fas fa-rss"></i> Feed</a></li>
                    <li><a href="#" onclick="showSection('scraps')"><i class="fas fa-envelope"></i> Mural (Scraps)</a></li>
                    <li><a href="#" onclick="showSection('photos')"><i class="fas fa-camera"></i> Fotos</a></li>
                    <li><a href="#" id="progressLink"><i class="fas fa-chart-line"></i> Meu Progresso</a></li>
                    <li><a href="desafios.html"><i class="fas fa-trophy"></i> Desafios</a></li>
                </ul>
            </div>

            <div class="stats-widget">
                <div class="stats-widget-header"><i class="fas fa-bolt"></i> Meu Progresso</div>
                <div class="stat-row">
                    <span class="stat-label">Aulas:</span>
                    <span id="stat-aulas" class="stat-value">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Calorias:</span>
                    <span id="stat-calorias" class="stat-value">0 kcal</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">M√©dia/Aula:</span>
                    <span id="stat-media" class="stat-value">0 kcal</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FC M√°xima:</span>
                    <span id="stat-fc-max" class="stat-value">0 bpm</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Tempo VO2:</span>
                    <span id="stat-vo2" class="stat-value">0 min</span>
                </div>
                <div id="motivational-msg" class="motivational-box">
                    üî• Carregando sua motiva√ß√£o...
                </div>
            </div>

            <div class="box">
                <div class="box-header">Estat√≠sticas Sociais</div>
                <p>Desafios: <strong id="stat-challenges" class="pink">0</strong></p>
                <p>Likes: <strong id="stat-likes" class="pink">0</strong></p>
                <p>Matches: <strong id="stat-matches" class="pink">0</strong></p>
            </div>
        </aside>

        <main class="content-center">
            
            <div class="box search-box">
                <div class="box-header">Procurar Atletas</div>
                <input type="text" id="searchUsersInput" class="search-input" placeholder="Digite o nome do atleta...">
                <div id="searchResults" style="margin-top: 10px;"></div>
            </div>

            <div id="main-content-box" class="box">
                <div id="content-title" class="box-header">Feed de Not√≠cias</div>
                
                <div id="post-area" class="post-input-area">
                    <div class="post-input-wrapper">
                        <textarea id="postInput" placeholder="O que voc√™ est√° treinando hoje? (Digite @ para marcar amigos)" oninput="handleMentionInput(event)"></textarea>
                        <div id="mentionSuggestions" class="mention-suggestions"></div>
                    </div>
                    <div class="post-actions">
                        <select id="postPrivacy">
                            <option value="public">P√∫blico</option>
                            <option value="friends">S√≥ Amigos</option>
                            <option value="private">Privado</option>
                        </select>
                        <button class="btn-icon" onclick="triggerPhotoUpload()"><i class="fas fa-image"></i> Foto</button>
                        <input type="file" id="photoInput" style="display:none;" accept="image/*" onchange="previewPhoto(event)">
                        <button class="btn-post" onclick="createPost()">Postar</button>
                    </div>
                    <div id="photoPreview" style="margin-top: 10px;"></div>
                </div>

                <div id="dynamic-list">
                    <p style="text-align: center; color: #888;">Carregando conte√∫do...</p>
                </div>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="box">
                <div class="box-header">WOD Match üî•</div>
                <div id="matchCandidate" class="match-sidebar-card">
                    <p style="color: #888; padding: 20px;">Buscando atletas...</p>
                </div>
            </div>

            <div class="box">
                <div class="box-header">
                    Meus Amigos <span id="friendsCount">(0)</span>
                </div>
                <div id="friendsGrid" class="friends-grid"></div>
                <a href="#" style="display: block; margin-top: 10px; text-align: right; color: var(--orkut-dark-blue);">ver todos</a>
            </div>

            <div class="box">
                <div class="box-header">Pedidos de Amizade</div>
                <div id="pendingRequests">
                    <p style="font-size: 11px; color: #888;">Nenhum pedido.</p>
                </div>
            </div>
        </aside>

    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 class="blue">Editar Perfil</h3>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
            <div class="form-group">
                <label>Bio:</label>
                <textarea id="bioInput" style="height: 80px;"></textarea>
            </div>
            <div class="form-group">
                <label>Foto de Capa (URL):</label>
                <input type="text" id="coverInput">
            </div>
            <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                <button class="btn-post" onclick="saveProfile()">Salvar</button>
                <button onclick="closeEditModal()" style="padding: 5px 10px; background: #ccc; border: none; cursor: pointer;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="notificationsModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <h3 class="blue">Notifica√ß√µes</h3>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
            <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: #888;">Carregando notifica√ß√µes...</p>
            </div>
            <div style="text-align: right; margin-top: 15px;">
                <button onclick="closeNotificationsModal()" style="padding: 5px 10px; background: #ccc; border: none; cursor: pointer;">Fechar</button>
            </div>
        </div>
    </div>

    <div id="photosModal" class="modal">
        <div class="modal-content">
            <h3 class="blue">Meu √Ålbum de Fotos</h3>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
            <div class="form-group">
                <label>Enviar Foto:</label>
                <input type="file" id="albumPhotoInput" accept="image/*" onchange="uploadAlbumPhoto(event)">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o (opcional):</label>
                <textarea id="photoDescription" style="height: 60px;"></textarea>
            </div>
            <div class="form-group">
                <label>Privacidade:</label>
                <select id="photoPrivacy">
                    <option value="public">P√∫blico</option>
                    <option value="friends">S√≥ Amigos</option>
                    <option value="private">Privado</option>
                </select>
            </div>
            <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                <button class="btn-post" onclick="saveAlbumPhoto()">Salvar Foto</button>
                <button onclick="closePhotosModal()" style="padding: 5px 10px; background: #ccc; border: none; cursor: pointer;">Fechar</button>
            </div>
            <div id="albumPhotosGrid" style="margin-top: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token');
        let currentSection = 'feed';
        let userData = null;
        let candidates = [];
        let currentCandidateIndex = 0;
        let selectedPhotoData = null;
        let selectedAlbumPhotoData = null;
        let allFriends = [];

        if (!token) window.location.href = 'login.html';

        let notificationsCount = 0;
        let allNotifications = [];

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image') || photo.startsWith('http')) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function triggerPhotoUpload() {
            document.getElementById('photoInput').click();
        }

        async function previewPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedPhotoData = await fileToBase64(file);
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<img src="${selectedPhotoData}" style="max-width: 200px; max-height: 200px; border: 1px solid #ccc; border-radius: 4px;">`;
        }

        async function handleMentionInput(event) {
            const text = event.target.value;
            const cursorPosition = event.target.selectionStart;
            const lastAtIndex = text.lastIndexOf('@', cursorPosition - 1);
            const suggestionsDiv = document.getElementById('mentionSuggestions');
            
            if (lastAtIndex !== -1) {
                const query = text.substring(lastAtIndex + 1, cursorPosition).toLowerCase();
                const filteredFriends = allFriends.filter(f => f.name.toLowerCase().includes(query));
                
                if (filteredFriends.length > 0) {
                    suggestionsDiv.innerHTML = filteredFriends.map(f => `
                        <div class="mention-item" onclick="selectMention('${f.name}', ${lastAtIndex})">
                            <strong>${f.name}</strong>
                        </div>
                    `).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        function selectMention(name, atIndex) {
            const input = document.getElementById('postInput');
            const text = input.value;
            const before = text.substring(0, atIndex);
            const after = text.substring(input.selectionStart);
            input.value = before + '@' + name + ' ' + after;
            document.getElementById('mentionSuggestions').style.display = 'none';
            input.focus();
        }

        async function loadProfile() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                userData = await res.json();
                
                document.getElementById('userPhotoLarge').src = formatPhoto(userData.photo);
                document.getElementById('userName').textContent = userData.name || 'Atleta';
                document.getElementById('userBio').textContent = userData.bio || 'Sem bio definida.';
                document.getElementById('progressLink').href = `meu-progresso.html?id=${userData.id}`;
                
                document.getElementById('stat-challenges').textContent = userData.stats?.challenges || 0;
                document.getElementById('stat-likes').textContent = userData.stats?.likes || 0;
                document.getElementById('stat-matches').textContent = userData.stats?.matches || 0;

                loadStats();
                loadContent();
                loadFriends();
                loadMatchCandidates();
                loadPendingRequests();
                loadNotifications();
            } catch (err) {
                console.error('Erro ao carregar perfil:', err);
            }
        }

        async function loadStats() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/sessions/historico`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const historicoData = await response.json();

        if (Array.isArray(historicoData)) {
            const totalAulas = historicoData.length;
            const totalCalorias = historicoData.reduce((sum, h) => sum + (h.calories_total || 0), 0);
            const totalVO2 = historicoData.reduce((sum, h) => sum + (h.vo2_time_seconds || 0), 0) / 60;
            const maxHrHistorica = Math.max(...historicoData.map(h => h.max_hr_reached || 0), 0);
            const avgCalorias = totalAulas > 0 ? totalCalorias / totalAulas : 0;

            // Atualiza os elementos na tela
            document.getElementById('stat-aulas').textContent = totalAulas;
            document.getElementById('stat-calorias').textContent = Math.round(totalCalorias) + ' kcal';
            document.getElementById('stat-media').textContent = Math.round(avgCalorias) + ' kcal';
            document.getElementById('stat-fc').textContent = Math.round(maxHrHistorica) + ' bpm';
            document.getElementById('stat-vo2').textContent = Math.round(totalVO2) + ' min';
            
            document.getElementById('frase-motivacional').textContent = 
                `üî• Voc√™ j√° fez ${totalAulas} aulas e queimou ${Math.round(totalCalorias)} calorias no total!`;
        }
    } catch (err) {
        console.error('Erro ao carregar estat√≠sticas:', err);
        document.getElementById('frase-motivacional').textContent = '‚ùå Erro ao carregar seus dados de treino.';
    }
}


        async function loadContent() {
            const container = document.getElementById('dynamic-list');
            const title = document.getElementById('content-title');
            const postArea = document.getElementById('post-area');

            if (currentSection === 'feed') {
                title.textContent = 'Feed de Not√≠cias';
                postArea.style.display = 'block';
                loadFeed();
            } else if (currentSection === 'scraps') {
                title.textContent = 'Mural de Recados (Scraps)';
                postArea.style.display = 'none';
                loadScraps();
            } else if (currentSection === 'photos') {
                title.textContent = 'Minhas Fotos';
                postArea.style.display = 'none';
                openPhotosModal();
            }
        }

        async function loadFeed() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/feed`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const posts = await res.json();
                const container = document.getElementById('dynamic-list');

                if (posts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Nenhuma postagem no feed.</p>';
                    return;
                }

                container.innerHTML = posts.map(post => `
                    <div class="feed-item">
                        <div class="feed-header">
                            <div class="feed-header-left">
                                <img src="${formatPhoto(post.user_photo)}" class="feed-photo-small" onclick="openProfile(${post.user_id})">
                                <div class="feed-info">
                                    <div class="feed-author" onclick="openProfile(${post.user_id})">${post.user_name}</div>
                                    <div class="feed-time">${new Date(post.created_at).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                        <div class="feed-content">${post.content}</div>
                        ${post.photo_data ? `<img src="${post.photo_data}" class="feed-image">` : ''}
                        <div class="feed-reactions">
                            <div class="reaction-buttons">
                                <button class="reaction-btn ${post.user_reaction === 'like' ? 'active' : ''}" onclick="reactToPost(${post.id}, 'like')">
                                    <i class="fas fa-thumbs-up"></i> CURTI (${post.likes_count || 0})
                                </button>
                                <button class="reaction-btn ${post.user_reaction === 'dislike' ? 'active' : ''}" onclick="reactToPost(${post.id}, 'dislike')">
                                    <i class="fas fa-thumbs-down"></i> PODE MELHORAR (${post.dislikes_count || 0})
                                </button>
                                ${post.user_id === userData.id ? `
                                <button class="delete-btn" onclick="deletePost(${post.id})">
                                    <i class="fas fa-trash"></i> EXCLUIR
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar feed:', err);
            }
        }

        async function loadScraps() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/scraps/${userData.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const scraps = await res.json();
                const container = document.getElementById('dynamic-list');

                if (scraps.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Nenhum recado no seu mural.</p>';
                    return;
                }

                container.innerHTML = scraps.map(scrap => `
                    <div class="feed-item">
                        <div class="feed-header">
                            <img src="${formatPhoto(scrap.user_photo)}" class="feed-photo-small" onclick="openProfile(${scrap.user_id})">
                            <div class="feed-info">
                                <div class="feed-author" onclick="openProfile(${scrap.user_id})">${scrap.user_name}</div>
                                <div class="feed-time">${new Date(scrap.created_at).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="feed-content">${scrap.content}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar scraps:', err);
            }
        }

        async function createPost() {
            const content = document.getElementById('postInput').value.trim();
            const privacy = document.getElementById('postPrivacy').value;

            if (!content && !selectedPhotoData) {
                alert('Escreva algo ou selecione uma foto!');
                return;
            }

            const body = {
                content: content,
                privacy: privacy,
                photoData: selectedPhotoData
            };

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/posts`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    document.getElementById('postInput').value = '';
                    document.getElementById('photoPreview').innerHTML = '';
                    selectedPhotoData = null;
                    document.getElementById('photoInput').value = '';
                    loadContent();
                } else {
                    const errData = await res.json();
                    alert('Erro ao postar: ' + (errData.error || 'Erro desconhecido'));
                }
            } catch (err) {
                alert('Erro de conex√£o');
            }
        }

        async function reactToPost(postId, reactionType) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/posts/${postId}/react`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ reactionType })
                });

                if (res.ok) {
                    loadContent();
                }
            } catch (err) {
                console.error('Erro ao reagir:', err);
            }
        }

        async function deletePost(postId) {
            if (!confirm('Tem certeza que deseja excluir esta postagem?')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadContent();
                } else {
                    const errData = await res.json();
                    alert('Erro ao excluir: ' + (errData.error || 'Erro desconhecido'));
                }
            } catch (err) {
                console.error('Erro ao excluir postagem:', err);
                alert('Erro de conex√£o ao excluir postagem');
            }
        }

        async function uploadAlbumPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            selectedAlbumPhotoData = await fileToBase64(file);
        }

        async function saveAlbumPhoto() {
            if (!selectedAlbumPhotoData) {
                alert('Selecione uma foto!');
                return;
            }

            const body = {
                photoData: selectedAlbumPhotoData,
                description: document.getElementById('photoDescription').value,
                privacy: document.getElementById('photoPrivacy').value
            };

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/upload`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    alert('Foto salva com sucesso!');
                    document.getElementById('albumPhotoInput').value = '';
                    document.getElementById('photoDescription').value = '';
                    selectedAlbumPhotoData = null;
                    loadAlbumPhotos();
                }
            } catch (err) {
                alert('Erro ao salvar foto');
            }
        }

        async function loadAlbumPhotos() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/${userData.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const photos = await res.json();

                const grid = document.getElementById('albumPhotosGrid');
                if (photos.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; color: #888;">Nenhuma foto ainda.</p>';
                    return;
                }

                grid.innerHTML = photos.map(photo => `
                    <div style="text-align: center;">
                        <img src="${photo.photo_data}" style="width: 100%; height: 150px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px;">
                        <p style="font-size: 10px; margin-top: 5px; color: #666;">${photo.description || 'Sem descri√ß√£o'}</p>
                        <button class="btn-icon" onclick="postPhotoToFeed(${photo.id})" style="margin-top: 5px; font-size: 10px;">Postar no Feed</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar fotos:', err);
            }
        }

        async function postPhotoToFeed(photoId) {
            const caption = prompt('Adicione uma legenda (opcional):');
            const privacy = prompt('Privacidade (public/friends/private):', 'public');

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/${photoId}/post-to-feed`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ caption: caption || '', privacy })
                });

                if (res.ok) {
                    alert('Foto postada no feed!');
                    closePhotosModal();
                    showSection('feed');
                }
            } catch (err) {
                alert('Erro ao postar foto');
            }
        }

        let searchTimeout;
        document.getElementById('searchUsersInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }
            searchTimeout = setTimeout(() => searchUsers(query), 500);
        });

        async function searchUsers(query) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/search-users?q=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const container = document.getElementById('searchResults');
                if (data.users.length === 0) {
                    container.innerHTML = '<p style="color:#888;">Nenhum atleta encontrado.</p>';
                    return;
                }
                container.innerHTML = data.users.map(user => `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 5px; border-bottom: 1px solid #eee;">
                        <img src="${formatPhoto(user.photo)}" style="width: 30px; height: 30px; object-fit: cover;">
                        <div style="flex: 1;">
                            <strong class="blue" style="cursor:pointer" onclick="openProfile(${user.id})">${user.name}</strong>
                            <div style="font-size: 10px; color: #999;">Box: ${user.box_id || '--'}</div>
                        </div>
                        <button onclick="requestFriendship(${user.id})" style="font-size: 10px;">Add</button>
                    </div>
                `).join('');
            } catch (err) {}
        }

        async function requestFriendship(targetId) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friend/request`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetId })
                });
                const data = await res.json();
                alert(data.message || 'Pedido enviado!');
            } catch (err) { alert('Erro ao enviar pedido'); }
        }

        async function loadFriends() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friends`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                allFriends = data.confirmedFriends || [];
                
                document.getElementById('friendsCount').textContent = `(${allFriends.length})`;
                const grid = document.getElementById('friendsGrid');
                grid.innerHTML = allFriends.slice(0, 9).map(f => `
                    <div class="friend-item" onclick="openProfile(${f.id})">
                        <img src="${formatPhoto(f.photo)}">
                        <span>${f.name.split(' ')[0]}</span>
                    </div>
                `).join('');
            } catch (err) { console.error('Erro ao carregar amigos:', err); }
        }

        async function loadPendingRequests() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friends`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const container = document.getElementById('pendingRequests');
                
                if (data.pendingRequests.length === 0) {
                    container.innerHTML = '<p style="font-size: 11px; color: #888;">Nenhum pedido.</p>';
                    return;
                }

                container.innerHTML = data.pendingRequests.map(req => `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 11px;">
                        <img src="${formatPhoto(req.photo)}" style="width: 25px; height: 25px; border-radius: 50%;">
                        <span style="flex: 1;">${req.name}</span>
                        <button onclick="respondFriend(${req.id}, 'accept')" style="background: var(--orkut-pink); color: white; border: none; padding: 2px 5px; cursor: pointer;">Aceitar</button>
                    </div>
                `).join('');
            } catch (err) {}
        }

        async function respondFriend(requesterId, action) {
            try {
                await fetch(`${API_BASE_URL}/api/social/friend/respond`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requesterId, action })
                });
                loadFriends();
                loadPendingRequests();
            } catch (err) {}
        }

        async function loadMatchCandidates() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/candidates`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                candidates = await res.json();
                displayCandidate();
            } catch (err) {}
        }

        function displayCandidate() {
            const container = document.getElementById('matchCandidate');
            if (candidates.length === 0 || currentCandidateIndex >= candidates.length) {
                container.innerHTML = '<p style="color: #888; padding: 20px;">Nenhum atleta novo por perto.</p>';
                return;
            }

            const c = candidates[currentCandidateIndex];
            container.innerHTML = `
                <img src="${formatPhoto(c.photo)}" class="match-photo-small">
                <div class="blue" style="font-weight: bold;">${c.name}</div>
                <div style="font-size: 10px; color: #666;">${c.box_name || 'WODPulse'}</div>
                <div class="match-actions-mini">
                    <button class="btn-match-mini btn-pass" onclick="matchAction(${c.id}, 'rejected')"><i class="fas fa-times"></i></button>
                    <button class="btn-match-mini btn-like" onclick="matchAction(${c.id}, 'matched')"><i class="fas fa-heart"></i></button>
                </div>
            `;
        }

        async function matchAction(targetId, status) {
            try {
                await fetch(`${API_BASE_URL}/api/social/match`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetId, status })
                });
                currentCandidateIndex++;
                displayCandidate();
            } catch (err) {}
        }

        function openProfile(userId) {
            window.location.href = `perfil-participante.html?id=${userId}`;
        }

        function openEditModal() {
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('bioInput').value = userData.bio || '';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function openPhotosModal() {
            document.getElementById('photosModal').style.display = 'flex';
            loadAlbumPhotos();
        }

        function closePhotosModal() {
            document.getElementById('photosModal').style.display = 'none';
        }

        async function saveProfile() {
            const bio = document.getElementById('bioInput').value.trim();
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/profile/update`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ bio: bio })
                });
                if (res.ok) {
                    alert('Perfil atualizado!');
                    closeEditModal();
                    loadProfile();
                }
            } catch (err) { alert('Erro ao salvar'); }
        }

        function showSection(section) {
            currentSection = section;
            loadContent();
        }

        function logout() {
            if (confirm('Sair do Orkut WODPulse?')) {
                localStorage.removeItem('wodpulse_social_token');
                window.location.href = 'login.html';
            }
        }

        async function loadNotifications() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allNotifications = await res.json();
                notificationsCount = allNotifications.filter(n => !n.is_read).length;
                updateNotificationBadge();
            } catch (err) {
                console.error('Erro ao carregar notificacoes:', err);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (notificationsCount > 0) {
                badge.textContent = notificationsCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleNotifications() {
            document.getElementById('notificationsModal').style.display = 'flex';
            displayNotifications();
        }

        function closeNotificationsModal() {
            document.getElementById('notificationsModal').style.display = 'none';
        }

        function displayNotifications() {
            const container = document.getElementById('notificationsList');
            if (allNotifications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Nenhuma notificacao.</p>';
                return;
            }

            container.innerHTML = ''; 

            allNotifications.forEach(notif => {
                let icon = 'üì¢';
                let message = '';
                
                if (notif.type === 'mention') {
                    icon = 'üè∑Ô∏è';
                    message = notif.from_user_name + ' te marcou em uma postagem';
                } else if (notif.type === 'like') {
                    icon = 'üëç';
                    message = notif.from_user_name + ' curtiu sua postagem';
                } else if (notif.type === 'dislike') {
                    icon = 'üëé';
                    message = notif.from_user_name + ' disse que pode melhorar sua postagem';
                } else if (notif.type === 'match') {
                    icon = '‚ù§Ô∏è';
                    message = notif.from_user_name + ' deu match com voce!';
                } else if (notif.type === 'friend_request') {
                    icon = 'üë•';
                    message = notif.from_user_name + ' enviou um pedido de amizade';
                }

                const itemDiv = document.createElement('div');
                itemDiv.style.padding = '10px';
                itemDiv.style.borderBottom = '1px solid #eee';
                itemDiv.style.backgroundColor = notif.is_read ? '#ffffff' : '#f0f8ff';

                const contentDiv = document.createElement('div');
                contentDiv.style.display = 'flex';
                contentDiv.style.alignItems = 'center';
                contentDiv.style.gap = '10px';

                const iconSpan = document.createElement('span');
                iconSpan.style.fontSize = '20px';
                iconSpan.textContent = icon;

                const textDiv = document.createElement('div');
                textDiv.style.flex = '1';

                const strongMsg = document.createElement('strong');
                strongMsg.textContent = message;

                const timeDiv = document.createElement('div');
                timeDiv.style.fontSize = '10px';
                timeDiv.style.color = '#999';
                timeDiv.style.marginTop = '3px';
                timeDiv.textContent = new Date(notif.created_at).toLocaleString();

                textDiv.appendChild(strongMsg);
                textDiv.appendChild(timeDiv);
                contentDiv.appendChild(iconSpan);
                contentDiv.appendChild(textDiv);
                itemDiv.appendChild(contentDiv);
                
                container.appendChild(itemDiv);
            });
        }

        setInterval(() => {
            loadNotifications();
        }, 30000);

        loadProfile();
        loadNotifications();
    </script>
</body>
</html>
