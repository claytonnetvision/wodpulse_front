<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V6 WODPulse - Leaderboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="logo-v6.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/4.2.0/dexie.min.js"></script>

    <!-- Estilos internos -->
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        #app-content {
            padding: 16px;
            box-sizing: border-box;
        }

        #setup {
            max-width: 900px;
            margin: 0 auto;
        }

        #addParticipant {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
        }

        #addParticipant input,
        #addParticipant select {
            padding: 10px;
            font-size: 15px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #161b22;
            color: white;
            min-width: 140px;
            flex: 1 1 180px;
        }

        #participantList {
            max-height: 50vh;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #participantList li {
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #participantList::-webkit-scrollbar {
            width: 8px;
        }

        #participantList::-webkit-scrollbar-track {
            background: #0d1117;
        }

        #participantList::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        /* Bot√£o Admin */
        .btn-admin {
            background: #ff9800;
            color: white;
            font-size: 18px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0 20px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(255,152,0,0.4);
        }
        .btn-admin:hover { background: #f57c00; }

        #admin-section { text-align: center; margin-bottom: 30px; }

        /* Estilos do Painel Admin */
        #admin-panel {
            padding: 20px;
            background: #0d1117;
        }
        #admin-panel table { width: 100%; border-collapse: collapse; margin: 20px 0; background: #161b22; }
        #admin-panel th, #admin-panel td { padding: 12px; border: 1px solid #30363d; text-align: left; }
        #admin-panel th { background: #21262d; }
        #admin-panel button { padding: 6px 12px; margin: 0 4px; cursor: pointer; border: none; border-radius: 4px; }
        .delete { background: #f85149; color: white; }
        .view { background: #238636; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #161b22; padding: 20px; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        #stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .card { background: #21262d; padding: 16px; border-radius: 6px; flex: 1; min-width: 200px; }
    </style>
</head>
<body>

    <!-- Conte√∫do principal -->
    <div id="app-content">

        <!-- Bot√£o Painel Admin -->
        <div id="admin-section">
            <button class="btn-admin" onclick="toggleAdminPanel()">Painel Admin üîß</button>
            <p style="font-size: 14px; color: #aaa;">Gerencie alunos e aulas (modo dev)</p>
        </div>

        <!-- Painel Admin (oculto inicialmente) -->
        <div id="admin-panel" class="hidden">
            <button class="btn-admin" onclick="toggleAdminPanel()" style="background:#f44336;">Voltar ao Principal</button>
            <h1>WODPulse - Painel Admin (Modo Dev - Sem Login)</h1>

            <div id="stats">
                <div class="card"><strong>Total Alunos:</strong> <span id="totalAlunos">0</span></div>
                <div class="card"><strong>Total Aulas:</strong> <span id="totalAulas">0</span></div>
                <div class="card"><strong>√öltima Aula:</strong> <span id="ultimaAula">--</span></div>
            </div>

            <h2>Alunos Cadastrados</h2>
            <input type="text" id="buscaAluno" placeholder="Buscar por nome..." style="padding:10px; width:300px; margin-bottom:10px;">
            <table id="tabelaAlunos">
                <thead><tr><th>ID</th><th>Nome</th><th>Idade</th><th>Peso</th><th>Altura</th><th>G√™nero</th><th>Email</th><th>Max HR</th><th>Device</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>

            <h2>Aulas Registradas</h2>
            <input type="text" id="buscaAula" placeholder="Buscar por nome da aula..." style="padding:10px; width:300px; margin-bottom:10px;">
            <table id="tabelaAulas">
                <thead><tr><th>ID</th><th>Aula</th><th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o min</th><th>Alunos</th><th>Queima Total</th><th>Calorias Total</th><th>A√ß√µes</th></tr></thead>
                <tbody></tbody>
            </table>

            <!-- Modal para detalhes -->
            <div id="modalDetalhes" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="document.getElementById('modalDetalhes').style.display='none'">&times;</span>
                    <h2>Detalhes da Aula</h2>
                    <div id="detalhesConteudo"></div>
                </div>
            </div>
        </div>

        <div id="setup">
            <h1>V6 WODPulse - Configurar Aula</h1>
            <button onclick="logout()" class="btn-logout">Sair</button>
            
            <!-- resto do setup igual ao original -->
            <div id="addParticipant">
                <input type="text" id="nameInput" placeholder="Nome do Aluno">
                <input type="number" id="ageInput" placeholder="Idade">
                <input type="number" id="weightInput" step="0.1" placeholder="Peso (kg)">
                <input type="number" id="heightInput" placeholder="Altura (cm)">
                <select id="genderInput">
                    <option value="">G√™nero</option>
                    <option value="M">Masculino</option>
                    <option value="F">Feminino</option>
                    <option value="O">Outro</option>
                </select>
                <input type="number" id="restingHRInput" placeholder="FC Repouso (opcional)">
                <input type="email" id="emailInput" placeholder="Email (opcional)">
                <label>
                    <input type="checkbox" id="useTanakaInput"> Usar f√≥rmula Tanaka (mais precisa)
                </label>
                <button id="addBtn" onclick="addNewParticipantFromSetup()">Adicionar Aluno</button>
            </div>

            <div id="participantListContainer">
                <h2>Alunos Cadastrados</h2>
                <p>Pulseiras ficam vinculadas permanentemente ao aluno at√© edi√ß√£o/exclus√£o.</p>
                <ul id="participantList"></ul>
            </div>

            <div id="last-class-summary" class="hidden">
                <h2>√öltima Aula Finalizada</h2>
                <div id="summary-content"></div>
            </div>

            <div id="checkins-section">
                <h2>Check-ins do Dia (Tecnofit - futuro)</h2>
                <p>Alunos com check-in hoje aparecer√£o aqui.</p>
                <ul id="checkinsList">
                    <li>(Integra√ß√£o pendente)</li>
                </ul>
            </div>

            <button id="startScanBtn">üöÄ Iniciar Aula / Escaneamento</button>
        </div>

        <div id="dashboard" class="hidden">
            <!-- dashboard completo igual ao original -->
            <button id="toggleCompactBtn" title="Alternar modo compacto">‚Üï</button>

            <div id="main-container">
                <div id="monitor-panel">
                    <div id="header">
                        <img src="logo-v6.png" alt="V6 CrossFit" id="logo">
                        
                        <div class="header-info">
                            <div id="current-class-name">Aula: --</div>
                            <div id="daily-leader">Campe√£o do Dia: -- (0 PONTOS)</div>
                            <div id="daily-calories-leader">Mais calorias hoje: -- (0 kcal)</div>
                        </div>
                        
                        <div id="timer">00:00</div>
                        
                        <div id="leaderboard-top">L√≠der Aula: -- (0 PONTOS BPM)</div>

                        <button id="reconnectDevicesBtn" class="hidden">üîÑ Reconectar Pulseiras</button>
                        <button id="authorizeReconnectBtn" class="hidden">Autorizar Reconex√£o Autom√°tica</button>
                        <button id="reportsBtn">üìÖ Relat√≥rios</button>
                    </div>

                    <div id="weekly-rankings">
                        <div class="ranking-block pontos">
                            <h3>üî• TOP 5 PONTOS BPM (Semana)</h3>
                            <div id="queima-ranking-top5" class="ranking-list"></div>
                        </div>

                        <div class="ranking-block calorias">
                            <h3>üî• TOP 5 CALORIAS (Semana)</h3>
                            <div id="calorias-ranking-top5" class="ranking-list"></div>
                        </div>

                        <div class="ranking-block vo2ZoneActive">
                            <h3>üî• TOP 5 VO2_ATIVO (Semana)</h3>
                            <div id="vo2ZoneActive" class="ranking-list"></div>
                        </div>

                        <div class="ranking-actions">
                            <button id="resetWeeklyBtn">üîÑ Resetar Semana</button>
                            <button id="fullRankingBtn">üìä Ranking Completo</button>
                            <button id="exportPdfBtn">üìÑ Exportar PDF</button>
                        </div>
                    </div>

                    <div id="participants"></div>
                </div>
            </div>
            
            <button id="addNewParticipantBtn" onclick="addParticipantDuringClass()">+ Aluno</button>
            <button id="backBtn">üèÅ Finalizar</button>
        </div>

        <!-- Modal Ranking Completo -->
        <div id="full-ranking-modal">
            <div>
                <span onclick="document.getElementById('full-ranking-modal').style.display='none'">√ó</span>
                <h2>Ranking Completo da Semana</h2>
                <div id="full-ranking-content"></div>
            </div>
        </div>

    </div>

    <script src="db.js"></script>
    <script src="script.js"></script>

    <!-- Script de autentica√ß√£o -->
    <script>
        // ... seu script de auth/login comentado igual ao original ...
        // (mantive exatamente igual, n√£o mudei nada aqui)
    </script>

    <!-- Novo: Script para toggle do Painel Admin + l√≥gica do admin -->
    <script>
        const API = 'https://wodpulse-back.onrender.com';

        function toggleAdminPanel() {
            const mainContent = document.querySelector('#setup, #dashboard');
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel.classList.contains('hidden')) {
                // Esconde conte√∫do principal e mostra admin
                document.querySelectorAll('#setup, #dashboard').forEach(el => el.classList.add('hidden'));
                adminPanel.classList.remove('hidden');
                carregarAlunos();
                carregarAulas();
            } else {
                // Volta ao principal
                adminPanel.classList.add('hidden');
                document.getElementById('setup').classList.remove('hidden'); // ou dashboard se preferir
            }
        }

        async function carregarAlunos() {
            try {
                const res = await fetch(`${API}/api/participants`);
                const data = await res.json();
                const participants = data.participants || [];
                document.getElementById('totalAlunos').textContent = participants.length;

                const tbody = document.querySelector('#tabelaAlunos tbody');
                tbody.innerHTML = '';
                participants.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.age || '-'}</td>
                        <td>${p.weight || '-'}</td>
                        <td>${p.height_cm || '-'}</td>
                        <td>${p.gender || '-'}</td>
                        <td>${p.email || '-'}</td>
                        <td>${p.max_hr || '-'}</td>
                        <td>${p.device_name || p.device_id || '-'}</td>
                        <td><button class="delete" onclick="excluirAluno(${p.id})">Excluir</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Erro ao carregar alunos:', err);
                alert('Erro ao carregar alunos. Verifique console.');
            }
        }

        async function carregarAulas() {
            try {
                const res = await fetch(`${API}/api/sessions`);
                const data = await res.json();
                const sessions = data.sessions || [];
                document.getElementById('totalAulas').textContent = sessions.length;

                if (sessions.length > 0) {
                    const ultima = new Date(sessions[0].date_start).toLocaleString('pt-BR');
                    document.getElementById('ultimaAula').textContent = `${sessions[0].class_name} - ${ultima}`;
                }

                const tbody = document.querySelector('#tabelaAulas tbody');
                tbody.innerHTML = '';
                sessions.forEach(s => {
                    const inicio = new Date(s.date_start).toLocaleString('pt-BR');
                    const fim = new Date(s.date_end).toLocaleString('pt-BR');
                    const dur = s.duration_minutes || (new Date(s.date_end) - new Date(s.date_start)) / 60000;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${s.id}</td>
                        <td>${s.class_name}</td>
                        <td>${inicio}</td>
                        <td>${fim}</td>
                        <td>${Math.round(dur)}</td>
                        <td>${s.participant_count || '-'}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <button class="view" onclick="verDetalhes(${s.id})">Ver</button>
                            <button class="delete" onclick="excluirAula(${s.id})">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Erro ao carregar aulas:', err);
                alert('Erro ao carregar aulas. Verifique console.');
            }
        }

        async function excluirAluno(id) {
            if (!confirm('Excluir aluno? Isso √© irrevers√≠vel.')) return;
            try {
                const res = await fetch(`${API}/api/participants/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Aluno exclu√≠do');
                    carregarAlunos();
                } else {
                    alert('Erro ao excluir aluno');
                }
            } catch (err) {
                alert('Erro de rede ao excluir aluno');
            }
        }

        async function excluirAula(id) {
            if (!confirm('Excluir aula e todos dados dela?')) return;
            try {
                const res = await fetch(`${API}/api/sessions/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Aula exclu√≠da');
                    carregarAulas();
                } else {
                    alert('Erro ao excluir aula');
                }
            } catch (err) {
                alert('Erro de rede ao excluir aula');
            }
        }

        async function verDetalhes(id) {
            try {
                const res = await fetch(`${API}/api/sessions/${id}`);
                const data = await res.json();
                if (!data.session) return alert('Sess√£o n√£o encontrada');

                let html = `<p><strong>Aula:</strong> ${data.session.class_name}</p>
                    <p><strong>In√≠cio:</strong> ${new Date(data.session.date_start).toLocaleString('pt-BR')}</p>
                    <p><strong>Fim:</strong> ${new Date(data.session.date_end).toLocaleString('pt-BR')}</p>`;

                // Se tiver participants no response (ajuste conforme sua rota /api/sessions/:id retorna)
                if (data.participants && data.participants.length > 0) {
                    html += '<h3>Alunos</h3><table><tr><th>Nome</th><th>Calorias</th><th>Queima Pts</th></tr>';
                    data.participants.forEach(p => {
                        html += `<tr><td>${p.name || 'Aluno'}</td><td>${Math.round(p.calories_total || 0)}</td><td>${Math.round(p.queima_points || 0)}</td></tr>`;
                    });
                    html += '</table>';
                } else {
                    html += '<p>Nenhum detalhe de alunos dispon√≠vel.</p>';
                }

                document.getElementById('detalhesConteudo').innerHTML = html;
                document.getElementById('modalDetalhes').style.display = 'flex';
            } catch (err) {
                alert('Erro ao carregar detalhes da aula');
                console.error(err);
            }
        }

        // Busca client-side
        document.getElementById('buscaAluno')?.addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('#tabelaAlunos tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        });

        document.getElementById('buscaAula')?.addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('#tabelaAulas tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        });
    </script>
</body>
</html>