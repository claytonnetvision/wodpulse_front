<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Atleta - WODPulse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style_social.css">
    <style>
        /* Ajustes específicos para a página de perfil */
        .profile-header-card {
            text-align: center;
            padding: 30px 20px;
        }
        .profile-pic-main {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-light);
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: var(--primary-light);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-box .value {
            display: block;
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
        }
        .stat-box .label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-action {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s;
            text-decoration: none;
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-challenge { background: var(--secondary); color: white; }
        .btn-friend { background: var(--primary); color: white; }
        
        @media (max-width: 768px) {
            .main-container { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container header-container">
            <a href="orkut-social.html" class="logo">wodpulse</a>
            <nav class="nav-top">
                <a href="orkut-social.html"><i class="fas fa-arrow-left"></i> Voltar</a>
            </nav>
        </div>
    </header>

    <div class="container main-container" style="grid-template-columns: 350px 1fr;">
        <!-- Lado Esquerdo: Info do Atleta -->
        <aside class="sidebar-left">
            <div class="sidebar-card profile-header-card">
                <img id="targetPhoto" class="profile-pic-main" src="https://www.infrapower.com.br/logo-v6.png">
                <h2 id="targetName" class="profile-name">Carregando...</h2>
                <p id="targetBio" style="color: var(--text-muted); font-size: 14px; margin-bottom: 10px;">...</p>
                <div id="targetBox" style="font-weight: 600; color: var(--primary); font-size: 13px;">
                    <i class="fas fa-map-marker-alt"></i> ...
                </div>

                <div class="action-buttons" id="actionButtons">
                    <a id="btnDesafiar" href="#" class="btn-action btn-challenge"><i class="fas fa-bolt"></i> Desafiar</a>
                    <button id="btnAddFriend" class="btn-action btn-friend" onclick="addFriend()"><i class="fas fa-user-plus"></i> Adicionar</button>
                </div>
            </div>

            <div class="sidebar-card">
                <div class="box-header">Estatísticas Sociais</div>
                <div class="stats-container">
                    <div class="stat-box">
                        <span id="stat-challenges" class="value">0</span>
                        <span class="label">Desafios</span>
                    </div>
                    <div class="stat-box">
                        <span id="stat-likes" class="value">0</span>
                        <span class="label">Likes</span>
                    </div>
                    <div class="stat-box">
                        <span id="stat-matches" class="value">0</span>
                        <span class="label">Matches</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Lado Direito: Progresso e Feed -->
        <main class="content-center">
            <div class="box">
                <div class="box-header">Progresso Técnico (WODPulse)</div>
                <div class="tech-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div class="tech-stat-item">
                        <span class="tech-stat-label">Aulas</span>
                        <span id="tech-aulas" class="tech-stat-value">0</span>
                    </div>
                    <div class="tech-stat-item">
                        <span class="tech-stat-label">Calorias</span>
                        <span id="tech-calorias" class="tech-stat-value">0 kcal</span>
                    </div>
                    <div class="tech-stat-item">
                        <span class="tech-stat-label">Média/Aula</span>
                        <span id="tech-media" class="tech-stat-value">0 kcal</span>
                    </div>
                    <div class="tech-stat-item">
                        <span class="tech-stat-label">FC Máxima</span>
                        <span id="tech-fc" class="tech-stat-value">0 bpm</span>
                    </div>
                </div>

                <!-- Feedback do Treinador (IA) -->
                <div id="feedbackSection" class="feedback-box" style="display:none; margin-top: 20px;">
                    <div class="feedback-title">
                        <i class="fas fa-robot"></i> Feedback do Treinador (IA)
                    </div>
                    <div id="feedbackContent" class="feedback-content"></div>
                </div>
            </div>

            <div class="box">
                <div class="box-header">Últimas Postagens</div>
                <div id="feedList">
                    <p style="text-align: center; padding: 20px; color: #999;">Carregando postagens...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token');
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('id');

        if (!targetId) window.location.href = 'orkut-social.html';

        // Configura o link do botão Desafiar
        document.getElementById('btnDesafiar').href = `desafiar-atleta.html?id=${targetId}`;

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image') || photo.startsWith('http')) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        async function loadAll() {
            let athleteName = "";

            // 1. Nome e Bio
            try {
                const res = await fetch(`${API_BASE_URL}/api/participants/${targetId}`);
                if (res.ok) {
                    const data = await res.json();
                    athleteName = data.participant?.name || data.name;
                    document.getElementById('targetName').textContent = athleteName;
                    document.getElementById('targetBio').textContent = data.participant?.bio || data.bio || 'Atleta WODPulse';
                    document.getElementById('targetBox').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${data.participant?.box_name || data.box_name || 'WODPulse'}`;
                }
            } catch (e) { console.error(e); }

            // 2. Foto e Stats Sociais
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/public-profile/${targetId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('targetPhoto').src = formatPhoto(data.photo);
                    if (data.stats) {
                        document.getElementById('stat-challenges').textContent = data.stats.challenges || 0;
                        document.getElementById('stat-likes').textContent = data.stats.likes || 0;
                        document.getElementById('stat-matches').textContent = data.stats.matches || 0;
                    }
                }
            } catch (e) { console.error(e); }

            // 3. Histórico (Filtro por ID do Atleta)
            try {
                console.log(`[DEBUG] Buscando histórico para o atleta ID: ${targetId}`);
                const res = await fetch(`${API_BASE_URL}/api/sessions/historico?alunoId=${targetId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const treinos = await res.json();
                    console.log(`[DEBUG] Treinos encontrados: ${treinos.length}`);

                    if (treinos.length > 0) {
                        const totalCal = treinos.reduce((s, h) => s + (parseFloat(h.calories_total) || 0), 0);
                        const maxHr = Math.max(...treinos.map(h => parseFloat(h.max_hr_reached) || 0), 0);
                        
                        document.getElementById('tech-aulas').textContent = treinos.length;
                        document.getElementById('tech-calorias').textContent = Math.round(totalCal) + ' kcal';
                        document.getElementById('tech-media').textContent = Math.round(totalCal / treinos.length) + ' kcal';
                        document.getElementById('tech-fc').textContent = Math.round(maxHr) + ' bpm';

                        const comIA = treinos.sort((a, b) => new Date(b.date_start) - new Date(a.date_start)).find(h => h.ia_comment);
                        if (comIA) {
                            document.getElementById('feedbackSection').style.display = 'block';
                            document.getElementById('feedbackContent').textContent = comIA.ia_comment;
                        }
                    } else {
                        console.log("[DEBUG] Nenhum treino encontrado para este atleta.");
                    }
                } else {
                    console.error("[DEBUG] Erro na resposta do histórico:", res.status);
                }
            } catch (e) { console.error("[DEBUG] Erro ao carregar histórico:", e); }

            // 4. Feed
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/feed?userId=${targetId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const posts = await res.json();
                    const userPosts = posts.filter(p => p.user_id == targetId);
                    document.getElementById('feedList').innerHTML = userPosts.length ? userPosts.map(p => `
                        <div class="feed-item">
                            <div class="feed-time">${new Date(p.created_at).toLocaleString()}</div>
                            <div class="feed-content">${p.content}</div>
                        </div>
                    `).join('') : 'Nenhuma postagem.';
                }
            } catch (e) { console.error(e); }
        }

        async function addFriend() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friend/request`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ targetId: targetId })
                });
                const data = await res.json();
                alert(data.message || 'Pedido enviado!');
            } catch (err) {
                alert('Erro ao enviar pedido.');
            }
        }

        if (targetId) loadAll();
    </script>
</body>
</html>
