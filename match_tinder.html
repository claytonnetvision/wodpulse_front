<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WODPulse Match</title>
    <link rel="stylesheet" href="style_tinder.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <a href="perfil_tinder.html" class="header-btn"><i class="fas fa-user"></i></a>
            <div class="logo-tinder">WODPulse</div>
            <a href="#" class="header-btn" onclick="openFilterPopup( )"><i class="fas fa-filter"></i></a>
        </header>

        <main class="card-stack-container">
            <div id="cardStack" class="card-stack">
                <!-- O JavaScript vai inserir os cards aqui. -->
            </div>
            <div id="loadingOrEmptyState" class="card-placeholder">
                <div class="spinner"></div>
                <p>Buscando atletas...</p>
            </div>
        </main>

        <footer class="actions-footer">
            <button class="action-btn btn-pass" onclick="handleAction('reject')"><i class="fas fa-times"></i></button>
            <a href="busca_tinder.html" class="action-btn btn-search"><i class="fas fa-search"></i></a>
            <button class="action-btn btn-like" onclick="handleAction('like')"><i class="fas fa-heart"></i></button>
        </footer>
    </div>

    <!-- POP-UP DE MATCH M√öTUO -->
    <div id="matchPopup" class="match-popup-overlay">
        <div class="match-popup-content">
            <h2>√â UM MATCH!</h2>
            <div class="match-photos">
                <img id="matchUser1" src="" alt="">
                <img id="matchUser2" src="" alt="">
            </div>
            <p>Voc√™ e <strong id="matchName">...</strong> deram like um no outro.</p>
            <button class="btn-popup btn-challenge">üèÜ Enviar um Desafio</button>
            <button class="btn-popup btn-chat">üí¨ Enviar Mensagem</button>
            <button class="btn-popup btn-close" onclick="closeMatchPopup()">Continuar Descobrindo</button>
        </div>
    </div>

    <!-- POP-UP DE FILTROS -->
    <div id="filterPopup" class="match-popup-overlay">
        <div class="match-popup-content">
            <h2>Filtros</h2>
            <div class="filter-group">
                <label>Mostrar perfis:</label>
                <div class="filter-options">
                    <button class="filter-btn" data-gender="M">Masculinos</button>
                    <button class="filter-btn" data-gender="F">Femininos</button>
                    <button class="filter-btn active" data-gender="all">Ambos</button>
                </div>
            </div>
            <button class="btn-popup btn-chat" onclick="applyFilters()">Aplicar Filtros</button>
            <button class="btn-popup btn-close" onclick="closeFilterPopup()">Cancelar</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token' );
        const selfId = localStorage.getItem('wodpulse_aluno_id');
        let selfPhoto = '';

        let candidates = [];
        let currentIndex = 0;

        const cardStack = document.getElementById('cardStack');
        const loadingOrEmptyState = document.getElementById('loadingOrEmptyState');

        if (!token) {
            alert('Token n√£o encontrado. Fa√ßa login.');
            // window.location.href = 'login_tinder.html';
        }

        function formatPhoto(photo) {
            if (!photo) return 'https://i.imgur.com/3g7A8vW.png';
            if (photo.startsWith('data:image' ) || photo.startsWith('http' )) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        async function loadSelfProfile() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const userData = await res.json();
                selfPhoto = formatPhoto(userData.photo);
            } catch (err) {
                console.error('Erro ao carregar perfil pr√≥prio:', err);
                selfPhoto = 'https://i.imgur.com/3g7A8vW.png';
            }
        }

        // ==================================================
        // FUN√á√ÉO loadCandidates CORRIGIDA
        // ==================================================
        async function loadCandidates( ) {
            // 1. Pega o filtro salvo no localStorage. Se n√£o houver, usa 'all'.
            const genderFilter = localStorage.getItem('wodpulse_gender_filter') || 'all';
            
            // 2. Monta a URL base da API.
            let apiUrl = `${API_BASE_URL}/api/social/candidates`;

            // 3. Se o filtro N√ÉO for 'all', adiciona o par√¢metro ?gender= na URL.
            if (genderFilter !== 'all') {
                apiUrl += `?gender=${genderFilter}`;
            }

            console.log(`[DEBUG] Buscando candidatos com a URL: ${apiUrl}`);

            loadingOrEmptyState.innerHTML = '<div class="spinner"></div><p>Buscando atletas...</p>';
            loadingOrEmptyState.style.display = 'flex';
            cardStack.innerHTML = '';

            try {
                const res = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Falha ao buscar candidatos.');
                
                candidates = await res.json();
                currentIndex = 0;
                renderCards();

            } catch (err) {
                console.error(err);
                loadingOrEmptyState.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Erro ao buscar atletas. Tente novamente.</p>';
            }
        }

        function renderCards() {
            if (candidates.length === 0) {
                loadingOrEmptyState.innerHTML = '<i class="fas fa-users-slash"></i><p>N√£o h√° novos atletas com este filtro. Tente outro!</p>';
                loadingOrEmptyState.style.display = 'flex';
                return;
            }
            
            loadingOrEmptyState.style.display = 'none';

            candidates.slice().reverse().forEach((user, index) => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.style.zIndex = index;
                card.innerHTML = `
                    <div class="profile-card-image" style="background-image: url('${formatPhoto(user.photo)}')"></div>
                    <div class="profile-card-info">
                        <h3>${user.name}, ${user.age || 'N/A'}</h3>
                        <p><i class="fas fa-dumbbell"></i> Box: ${user.box_id || 'WODPulse'}</p>
                    </div>
                `;
                cardStack.appendChild(card);
            });
        }

        async function handleAction(action) {
            if (currentIndex >= candidates.length) return;

            const topCard = cardStack.querySelector('.profile-card:last-child');
            if (!topCard) return;

            const user = candidates[currentIndex];

            let rotation = (Math.random() - 0.5) * 30;
            let translateX = 0;
            if (action === 'like') {
                translateX = '150%';
                rotation = 20;
            } else if (action === 'reject') {
                translateX = '-150%';
                rotation = -20;
            }
            topCard.style.transform = `translateX(${translateX}) rotate(${rotation}deg)`;
            topCard.style.opacity = 0;

            try {
                const res = await fetch(`${API_BASE_URL}/api/social/match`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ targetId: user.id, action: action })
                });
                const data = await res.json();

                if (data.mutualMatch) {
                    showMatchPopup(user);
                }

            } catch (err) {
                console.error('Erro ao registrar a√ß√£o:', err);
            }

            currentIndex++;
            setTimeout(() => {
                topCard.remove();
                if (currentIndex >= candidates.length) {
                    loadCandidates(); // CORRE√á√ÉO: Recarrega os candidatos quando acabam.
                }
            }, 300);
        }

        function showMatchPopup(matchedUser) {
            document.getElementById('matchUser1').src = selfPhoto;
            document.getElementById('matchUser2').src = formatPhoto(matchedUser.photo);
            document.getElementById('matchName').textContent = matchedUser.name.split(' ')[0];
            document.getElementById('matchPopup').classList.add('show');
        }

        function closeMatchPopup() {
            document.getElementById('matchPopup').classList.remove('show');
        }

        const filterPopup = document.getElementById('filterPopup');
        const filterButtons = document.querySelectorAll('.filter-btn');
        let selectedGender = localStorage.getItem('wodpulse_gender_filter') || 'all';

        // Garante que o bot√£o correto esteja ativo ao carregar a p√°gina
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.filter-btn[data-gender="${selectedGender}"]`).classList.add('active');

        function openFilterPopup() {
            filterPopup.classList.add('show');
        }

        function closeFilterPopup() {
            filterPopup.classList.remove('show');
        }

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                selectedGender = button.getAttribute('data-gender');
            });
        });

        // ==================================================
        // FUN√á√ÉO applyFilters CORRIGIDA
        // ==================================================
        function applyFilters() {
            closeFilterPopup();
            // 1. Salva a nova prefer√™ncia no localStorage.
            localStorage.setItem('wodpulse_gender_filter', selectedGender);
            
            // 2. Remove o alert e chama diretamente a fun√ß√£o para recarregar os candidatos.
            // A fun√ß√£o loadCandidates agora ler√° o valor salvo e montar√° a URL correta.
            console.log(`Filtro aplicado: ${selectedGender}. Recarregando candidatos...`);
            loadCandidates();
        }

        async function init() {
            await loadSelfProfile();
            await loadCandidates();
        }

        init();
    </script>
</body>
</html>
