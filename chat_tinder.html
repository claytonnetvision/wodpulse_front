<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chat - WODPulse</title>
    <link rel="stylesheet" href="style_tinder.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>

    <div class="app-container chat-container">
        <!-- CABEﾃ②LHO DO CHAT -->
        <header class="app-header chat-header">
            <a href="conversas_tinder.html" class="header-btn"><i class="fas fa-arrow-left"></i></a>
            <a href="#" id="chatHeaderLink" class="chat-header-user">
                <img id="chatUserPhoto" src="https://i.imgur.com/3g7A8vW.png" alt="Foto do usuﾃ｡rio" class="chat-user-photo">
                <span id="chatUserName">Carregando...</span>
            </a>
            <!-- Botﾃ｣o de "escudo" para seguranﾃｧa/denﾃｺncia, como no Tinder -->
            <a href="#" class="header-btn"><i class="fas fa-shield-alt"></i></a>
        </header>

        <!-- CORPO DAS MENSAGENS -->
        <main id="chatMessages" class="chat-messages-body">
            <!-- As mensagens reais serﾃ｣o carregadas aqui. Estas sﾃ｣o apenas exemplos visuais. -->
            <div class="message-bubble-wrapper other">
                <div class="message-bubble other">E aﾃｭ, bora treinar hoje? O WOD parece ser pesado.</div>
            </div>
            <div class="message-bubble-wrapper self">
                <div class="message-bubble self">Com certeza! Vi que ﾃｩ For Time. Prepara o cardio! 櫨</div>
            </div>
        </main>

        <!-- ﾃヽEA DE DIGITAﾃﾃグ -->
        <footer class="chat-input-footer">
            <a href="#" id="challengeChatButton" class="btn-icon-action" title="Enviar Desafio">醇</a>
            <input type="text" id="messageInput" class="chat-input-field" placeholder="Digite uma mensagem...">
            <button id="sendButton" class="btn-icon-action send-btn"><i class="fas fa-paper-plane"></i></button>
        </footer>
    </div>

    <!-- =================================== -->
    <!-- SCRIPT DE INTEGRAﾃﾃグ DO CHAT -->
    <!-- =================================== -->
    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token' );
        
        const urlParams = new URLSearchParams(window.location.search);
        const friendId = urlParams.get('id');

        if (!token || !friendId) {
            alert('Acesso invﾃ｡lido. ID do amigo nﾃ｣o encontrado.');
            window.location.href = 'conversas_tinder.html';
        }

        function formatPhoto(photo) {
            if (!photo) return 'https://i.imgur.com/3g7A8vW.png';
            if (photo.startsWith('data:image' ) || photo.startsWith('http' )) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        /**
         * Carrega as informaﾃｧﾃｵes do amigo no cabeﾃｧalho do chat.
         */
        async function loadFriendInfo() {
            console.log(`[CHAT DEBUG] Buscando informaﾃｧﾃｵes do amigo ID: ${friendId}`);
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/public-profile/${friendId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Nﾃ｣o foi possﾃｭvel carregar dados do amigo.');
                
                const friendData = await res.json();
                console.log('[CHAT DEBUG] Dados do amigo recebidos:', friendData);
                
                document.getElementById('chatUserPhoto').src = formatPhoto(friendData.photo);
                document.getElementById('chatUserName').textContent = friendData.name;
                // Link para o perfil do amigo
                document.getElementById('chatHeaderLink').href = `perfil_tinder.html?id=${friendId}`;
                // Link para criar um desafio com o amigo
                document.getElementById('challengeChatButton').href = `criar_desafio.html?opponentId=${friendId}`;

            } catch (err) {
                console.error('[CHAT DEBUG] Erro:', err);
                document.getElementById('chatUserName').textContent = 'Erro';
            }
        }

        /**
         * [FUNﾃﾃグ DE ESQUELETO] Carrega o histﾃｳrico de mensagens.
         * Esta funﾃｧﾃ｣o precisarﾃ｡ ser implementada quando a rota da API de mensagens existir.
         */
        // Dentro do <script> do chat_tinder.html

// SUBSTITUA A FUNﾃﾃグ ANTIGA POR ESTA:
async function loadMessages() {
    console.log(`[CHAT DEBUG] Buscando mensagens para o amigo ID: ${friendId}`);
    const chatBody = document.getElementById('chatMessages');
    chatBody.innerHTML = '<p class="loading-text">Carregando mensagens...</p>';

    try {
        const res = await fetch(`${API_BASE_URL}/api/social/messages/${friendId}`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!res.ok) throw new Error('Falha ao carregar mensagens.');
        
        const messages = await res.json();
        const selfId = localStorage.getItem('wodpulse_aluno_id');
        
        if (messages.length === 0) {
            chatBody.innerHTML = '<p class="loading-text">Nenhuma mensagem ainda. Comece a conversa!</p>';
            return;
        }

        chatBody.innerHTML = messages.map(msg => `
            <div class="message-bubble-wrapper ${msg.sender_id == selfId ? 'self' : 'other'}">
                <div class="message-bubble ${msg.sender_id == selfId ? 'self' : 'other'}">
                    ${msg.content}
                </div>
            </div>
        `).join('');

        chatBody.scrollTop = chatBody.scrollHeight;

    } catch (err) {
        console.error('[CHAT DEBUG] Erro ao carregar mensagens:', err);
        chatBody.innerHTML = `<p class="loading-text" style="color: var(--accent-pass);">${err.message}</p>`;
    }
}
// Dentro do <script> do chat_tinder.html

/**
 * NOVA FUNﾃﾃグ: Informa ao backend que as mensagens deste chat foram lidas.
 */
async function markMessagesAsRead() {
    console.log(`[CHAT DEBUG] Marcando mensagens do amigo ID ${friendId} como lidas.`);
    try {
        await fetch(`${API_BASE_URL}/api/social/messages/mark-as-read`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ friendId: friendId })
        });
    } catch (err) {
        console.error('[CHAT DEBUG] Erro ao marcar mensagens como lidas:', err);
    }
}




// SUBSTITUA A FUNﾃﾃグ ANTIGA POR ESTA:
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const messageContent = input.value.trim();
    if (messageContent === '') return;

    // Remove a simulaﾃｧﾃ｣o visual, pois a API agora vai cuidar disso
    input.value = ''; 

    try {
        const res = await fetch(`${API_BASE_URL}/api/social/messages/send`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ receiverId: friendId, content: messageContent })
        });
        if (!res.ok) {
            throw new Error('Falha ao enviar mensagem para a API.');
        }
        // Apﾃｳs enviar com sucesso, recarrega as mensagens para mostrar a nova
        loadMessages();
    } catch (err) {
        console.error('Erro de rede ao enviar mensagem:', err);
        alert('Nﾃ｣o foi possﾃｭvel enviar a mensagem.');
        input.value = messageContent; // Devolve o texto ao input se falhar
    }
}

// No final do seu script, chame a nova funﾃｧﾃ｣o junto com as outras:
loadFriendInfo();
loadMessages();
markMessagesAsRead(); // <-- ADICIONE ESTA LINHA
setInterval(loadMessages, 10000);


        // Adiciona os eventos aos botﾃｵes
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Inicia o carregamento da pﾃ｡gina
        loadFriendInfo();
        // loadMessages(); // Chamada para a funﾃｧﾃ｣o de esqueleto (descomente para testar)

    </script>

</body>
</html>
