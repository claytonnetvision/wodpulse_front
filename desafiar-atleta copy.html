<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WODPulse - Desafiar Atleta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --orkut-blue: #6d84b4;
            --orkut-light-blue: #e7ebf2;
            --orkut-bg: #d4dff1;
            --orkut-pink: #f03e9b;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--orkut-bg);
            margin: 0;
            padding: 0;
            color: #333;
        }

        .header {
            background-color: var(--orkut-blue);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 0 15px;
        }

        .card {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .card-title {
            background-color: var(--orkut-light-blue);
            padding: 8px;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
            color: var(--orkut-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .ranking-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            background: #eee;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: bold;
            font-size: 14px;
        }

        .ranking-val {
            color: var(--orkut-pink);
            font-weight: bold;
        }

        .btn-filter {
            background: white;
            border: 1px solid var(--orkut-blue);
            color: var(--orkut-blue);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .btn-filter.active {
            background: var(--orkut-blue);
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn-primary {
            background-color: var(--orkut-pink);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .participant-tag {
            display: inline-block;
            background: var(--orkut-light-blue);
            padding: 5px 10px;
            border-radius: 15px;
            margin: 5px;
            font-size: 13px;
            border: 1px solid var(--orkut-blue);
        }

        .participant-tag i {
            margin-left: 5px;
            cursor: pointer;
            color: red;
        }

        #diagnostic-console {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <div style="font-weight: bold; font-size: 20px;">orkut <span style="font-weight: normal;">WODPulse</span></div>
    <div>
        <a href="orkut-social.html" style="color: white; text-decoration: none; margin-right: 15px;">In√≠cio</a>
        <a href="#" onclick="logout()" style="color: white; text-decoration: none;">Sair</a>
    </div>
</div>

<div class="container">
    <!-- Sidebar: Ranking Geral -->
    <div class="sidebar">
        <div class="card">
            <div class="card-title">
                Top 5 Calorias üî•
                <div>
                    <button class="btn-filter active" onclick="loadRanking(1, this)">24h</button>
                    <button class="btn-filter" onclick="loadRanking(3, this)">3d</button>
                    <button class="btn-filter" onclick="loadRanking(7, this)">7d</button>
                </div>
            </div>
            <div id="ranking-list">
                <p style="text-align: center; color: #666;">Carregando...</p>
            </div>
        </div>
    </div>

    <!-- Main: Criar Desafio -->
    <div class="main">
        <div class="card">
            <div class="card-title">Criar Novo Desafio</div>
            
            <div class="form-group">
                <label>T√≠tulo do Desafio:</label>
                <input type="text" id="challenge-title" placeholder="Ex: Guerra de Calorias">
            </div>

            <div class="form-group">
                <label>Convidar Atletas:</label>
                <div style="display: flex; gap: 10px;">
                    <select id="athlete-select">
                        <option value="">Selecione um atleta...</option>
                    </select>
                    <button class="btn-filter" onclick="addParticipant()" style="height: 35px;">Adicionar</button>
                </div>
                <div id="participants-list" style="margin-top: 10px;">
                    <!-- Tags de participantes aqui -->
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Data In√≠cio:</label>
                    <input type="date" id="start-date">
                </div>
                <div class="form-group">
                    <label>Data Fim:</label>
                    <input type="date" id="end-date">
                </div>
            </div>

            <button class="btn-primary" onclick="createChallenge()">CRIAR E ENVIAR CONVITES</button>
        </div>

        <div id="diagnostic-console">
            [SISTEMA] Aguardando comandos...
        </div>
    </div>
</div>

<script>
    const API_BASE = "https://wodpulse-back.onrender.com/api";
    const token = localStorage.getItem("wodpulse_social_token");
    const studentId = localStorage.getItem("studentId");
    let selectedParticipants = [];

    function log(msg) {
        const console = document.getElementById("diagnostic-console");
        const time = new Date().toLocaleTimeString();
        console.innerHTML += `<br>[${time}] ${msg}`;
        console.scrollTop = console.scrollHeight;
    }

    // Inicializa√ß√£o
    window.onload = async () => {
        log("Iniciando p√°gina...");
        if (!token) {
            log("ERRO: Usu√°rio n√£o logado.");
            window.location.href = "login.html";
            return;
        }

        // Pegar ID da URL se vier do perfil
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('id');
        
        await loadAthletes(targetId);
        await loadRanking(1);
    };

    async function loadAthletes(targetId) {
        try {
            log("Buscando lista de atletas...");
            const res = await fetch(`${API_BASE}/social/search-users?q=`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const data = await res.json();
            const select = document.getElementById("athlete-select");
            
            if (data.users) {
                data.users.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.id;
                    opt.text = p.name;
                    select.add(opt);
                    
                    if (targetId && p.id == targetId) {
                        addParticipantById(p.id, p.name);
                    }
                });
            }
            log("Lista de atletas carregada.");
        } catch (err) {
            log("ERRO ao carregar atletas: " + err.message);
        }
    }

    function addParticipant() {
        const select = document.getElementById("athlete-select");
        const id = select.value;
        const name = select.options[select.selectedIndex].text;
        if (id) addParticipantById(id, name);
    }

    function addParticipantById(id, name) {
        if (selectedParticipants.includes(id)) return;
        selectedParticipants.push(id);
        
        const list = document.getElementById("participants-list");
        const tag = document.createElement("span");
        tag.className = "participant-tag";
        tag.innerHTML = `${name} <i class="fas fa-times" onclick="removeParticipant('${id}', this)"></i>`;
        list.appendChild(tag);
        log(`Atleta adicionado: ${name}`);
    }

    function removeParticipant(id, el) {
        selectedParticipants = selectedParticipants.filter(p => p != id);
        el.parentElement.remove();
    }

    async function loadRanking(days, btn) {
        if (btn) {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        const list = document.getElementById("ranking-list");
        list.innerHTML = '<p style="text-align: center; color: #666;">Carregando...</p>';
        
        try {
            log(`Buscando ranking de ${days} dias...`);
            const res = await fetch(`${API_BASE}/challenges/top-calories?days=${days}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            
            if (!res.ok) throw new Error(`Status ${res.status}`);
            
            const data = await res.json();
            list.innerHTML = "";
            
            if (data.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">Nenhum treino no per√≠odo.</p>';
            }

            data.forEach(item => {
                const photo = item.photo ? (item.photo.startsWith('data:') ? item.photo : `data:image/jpeg;base64,${item.photo}`) : 'https://www.infrapower.com.br/logo-v6.png';
                list.innerHTML += `
                    <div class="ranking-item">
                        <img src="${photo}" class="ranking-photo">
                        <div class="ranking-info">
                            <div class="ranking-name">${item.name}</div>
                            <div class="ranking-val">${Math.round(item.total_calories)} kcal</div>
                        </div>
                    </div>
                `;
            });
            log("Ranking carregado com sucesso.");
        } catch (err) {
            log("ERRO no ranking: " + err.message);
            list.innerHTML = '<p style="text-align: center; color: red;">Erro ao carregar.</p>';
        }
    }

    async function createChallenge() {
        const title = document.getElementById("challenge-title").value;
        const start = document.getElementById("start-date").value;
        const end = document.getElementById("end-date").value;

        if (!title || !start || !end || selectedParticipants.length === 0) {
            alert("Preencha todos os campos e convide pelo menos um atleta!");
            return;
        }

        try {
            log(`Tentando criar desafio: ${title}`);
            const res = await fetch(`${API_BASE}/challenges/create`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    title,
                    startDate: start,
                    endDate: end,
                    invitedParticipants: selectedParticipants
                })
            });

            const result = await res.json();
            
            if (res.ok) {
                log("SUCESSO! Desafio criado e convites enviados.");
                alert("Desafio criado com sucesso! Aguarde os atletas aceitarem.");
                window.location.href = "orkut-social.html";
            } else {
                log("ERRO do servidor: " + (result.error || "Erro desconhecido"));
                alert("Erro: " + (result.error || "N√£o foi poss√≠vel criar o desafio."));
            }
        } catch (err) {
            log("ERRO de conex√£o: " + err.message);
            alert("Erro de conex√£o com o servidor.");
        }
    }

    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }
</script>

</body>
</html>
