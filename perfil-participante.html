<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - WODPulse Orkut</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
    <style>
        :root {
            --orkut-blue: #EDF3FD;
            --orkut-header: #BFD0EA;
            --orkut-pink: #FF0084;
            --orkut-text: #333;
            --orkut-border: #C5D5F0;
            --orkut-dark-blue: #6D84B4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: var(--orkut-blue);
            color: var(--orkut-text);
            font-size: 12px;
        }

        header {
            background-color: white;
            border-bottom: 1px solid var(--orkut-border);
            padding: 5px 0;
        }

        .header-container {
            max-width: 950px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--orkut-pink);
            text-decoration: none;
        }

        .nav-top a {
            color: var(--orkut-dark-blue);
            text-decoration: none;
            margin-left: 15px;
            font-weight: bold;
        }

        .main-container {
            max-width: 950px;
            margin: 15px auto;
            display: grid;
            grid-template-columns: 180px 1fr 250px;
            gap: 15px;
        }

        .sidebar-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .profile-box {
            background: white;
            border: 1px solid var(--orkut-border);
            padding: 10px;
            text-align: center;
        }

        .profile-pic-large {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .profile-name {
            font-weight: bold;
            color: var(--orkut-dark-blue);
            margin-bottom: 5px;
            display: block;
        }

        .stats-widget {
            background: #fff;
            border: 1px solid var(--orkut-border);
            padding: 10px;
            margin-top: 10px;
            text-align: left;
        }

        .stats-widget-header {
            font-weight: bold;
            color: var(--orkut-dark-blue);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
        }

        .stat-label { color: #666; }
        .stat-value { font-weight: bold; color: var(--orkut-pink); }

        .content-center {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .box {
            background: white;
            border: 1px solid var(--orkut-border);
            padding: 15px;
        }

        .box-header {
            background: var(--orkut-header);
            padding: 5px 10px;
            font-weight: bold;
            color: var(--orkut-dark-blue);
            margin: -15px -15px 15px -15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
            text-align: center;
        }

        .btn-add-friend {
            background: var(--orkut-pink);
            color: white;
        }

        .btn-challenge {
            background: var(--orkut-dark-blue);
            color: white;
        }

        .btn:hover { opacity: 0.9; }

        .feed-item {
            border-bottom: 1px dotted #ccc;
            padding: 10px 0;
        }

        .feed-item:last-child { border-bottom: none; }

        .feed-header {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .feed-photo-small {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }

        .feed-info {
            flex: 1;
        }

        .feed-author {
            font-weight: bold;
            color: var(--orkut-dark-blue);
        }

        .feed-time {
            color: #999;
            font-size: 10px;
        }

        .feed-content {
            margin: 8px 0;
            line-height: 1.4;
        }

        .feed-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            margin: 8px 0;
            border: 1px solid #ddd;
        }

        .sidebar-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .friend-item {
            text-align: center;
            font-size: 10px;
            cursor: pointer;
        }

        .friend-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #ccc;
        }

        .friend-item span {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--orkut-dark-blue);
        }

        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .error {
            background: #ffe0e0;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <a href="orkut-social-final.html" class="logo">orkut <span style="font-weight: normal; font-size: 14px; color: #666;">WODPulse</span></a>
            <nav class="nav-top">
                <a href="orkut-social-final.html">← Voltar</a>
            </nav>
        </div>
    </header>

    <div class="main-container">
        
        <aside class="sidebar-left">
            <div class="profile-box">
                <img id="userPhotoLarge" class="profile-pic-large" src="https://www.infrapower.com.br/logo-v6.png" alt="Foto">
                <span id="userName" class="profile-name">Carregando...</span>
                <p id="userBio" style="font-size: 11px; color: #666;"></p>
                
                <div class="action-buttons">
                    <button class="btn btn-add-friend" onclick="addFriend()"><i class="fas fa-user-plus"></i> Adicionar</button>
                    <button class="btn btn-challenge" onclick="challengeUser()"><i class="fas fa-trophy"></i> Desafiar</button>
                </div>
            </div>

            <div class="stats-widget">
                <div class="stats-widget-header"><i class="fas fa-bolt"></i> Progresso</div>
                <div class="stat-row">
                    <span class="stat-label">Aulas:</span>
                    <span id="stat-aulas" class="stat-value">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Calorias:</span>
                    <span id="stat-calorias" class="stat-value">0 kcal</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Média/Aula:</span>
                    <span id="stat-media" class="stat-value">0 kcal</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FC Máxima:</span>
                    <span id="stat-fc-max" class="stat-value">0 bpm</span>
                </div>
            </div>
        </aside>

        <main class="content-center">
            <div class="box">
                <div class="box-header">Feed de Notícias</div>
                <div id="feedContainer" class="loading">Carregando feed...</div>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="box">
                <div class="box-header">
                    Amigos <span id="friendsCount">(0)</span>
                </div>
                <div id="friendsGrid" class="friends-grid"></div>
            </div>
        </aside>

    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token');
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');
        let userData = null;

        if (!token) window.location.href = 'login.html';
        if (!userId) {
            document.body.innerHTML = '<div class="error" style="margin: 20px;">Usuário não encontrado.</div>';
        }

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image') || photo.startsWith('http')) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        async function loadProfile() {
            try {
                // CORREÇÃO: Usando a rota correta do backend
                const res = await fetch(`${API_BASE_URL}/api/social/public-profile/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error('Erro ao carregar perfil');
                
                userData = await res.json();
                
                document.getElementById('userPhotoLarge').src = formatPhoto(userData.photo);
                document.getElementById('userName').textContent = userData.name || 'Atleta';
                document.getElementById('userBio').textContent = userData.bio || 'Sem bio definida.';
                
                loadTrainingStats();
                loadFeed();
                loadFriends();
            } catch (err) {
                console.error('Erro ao carregar perfil:', err);
                document.getElementById('feedContainer').innerHTML = '<div class="error">Erro ao carregar perfil do usuário.</div>';
            }
        }

        async function loadTrainingStats() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/sessions/historico?alunoId=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const historicoData = await res.json();
                
                if (historicoData && Array.isArray(historicoData)) {
                    const totalAulas = historicoData.length;
                    const totalCalorias = historicoData.reduce((sum, h) => sum + (h.calories_total || 0), 0);
                    const maxHrHistorica = Math.max(...historicoData.map(h => h.max_hr_reached || 0), userData.historical_max_hr || 0);
                    const avgCalorias = totalAulas > 0 ? totalCalorias / totalAulas : 0;

                    document.getElementById('stat-aulas').textContent = totalAulas;
                    document.getElementById('stat-calorias').textContent = Math.round(totalCalorias) + ' kcal';
                    document.getElementById('stat-media').textContent = Math.round(avgCalorias) + ' kcal';
                    document.getElementById('stat-fc-max').textContent = Math.round(maxHrHistorica) + ' bpm';
                }
            } catch (err) {
                console.error('Erro ao carregar estatísticas:', err);
            }
        }

        async function loadFeed() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/feed?userId=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const container = document.getElementById('feedContainer');
                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Nenhuma postagem.</p>';
                    return;
                }

                container.innerHTML = data.map(item => `
                    <div class="feed-item">
                        <div class="feed-header">
                            <img src="${formatPhoto(item.user_photo)}" class="feed-photo-small">
                            <div class="feed-info">
                                <div class="feed-author">${item.user_name}</div>
                                <div class="feed-time">${new Date(item.created_at).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="feed-content">${item.content}</div>
                        ${item.photo_data ? `<img src="${item.photo_data}" class="feed-image">` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar feed:', err);
                document.getElementById('feedContainer').innerHTML = '<div class="error">Erro ao carregar postagens.</div>';
            }
        }

        async function loadFriends() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/friends?userId=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const friends = data.confirmedFriends || [];

                const grid = document.getElementById('friendsGrid');
                document.getElementById('friendsCount').textContent = `(${friends.length})`;
                if (friends.length > 0) {
                    grid.innerHTML = friends.slice(0, 9).map(f => `
                        <div class="friend-item" onclick="openProfile(${f.id})">
                            <img src="${formatPhoto(f.photo)}">
                            <span>${f.name.split(' ')[0]}</span>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p style="grid-column: 1/-1; color: #888;">Nenhum amigo.</p>';
                }
            } catch (err) {
                console.error('Erro ao carregar amigos:', err);
            }
        }

        function addFriend() {
            if (!userData) return;
            const confirmed = confirm(`Adicionar ${userData.name} como amigo?`);
            if (!confirmed) return;

            fetch(`${API_BASE_URL}/api/social/friend/request`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ targetId: userId })
            }).then(res => res.json())
              .then(data => alert(data.message || 'Pedido enviado!'))
              .catch(err => alert('Erro ao enviar pedido'));
        }

        function challengeUser() {
            if (!userData) return;
            alert('Desafio para ' + userData.name + ' será implementado em breve!');
        }

        function openProfile(friendId) {
            window.location.href = `perfil-participante-orkut-fixed.html?id=${friendId}`;
        }

        loadProfile();
    </script>
</body>
</html>
