// Rota para ranking acumulado por aluno (total de todas as aulas)
sessionsRouter.get('/participants/ranking-acumulado', async (req, res) => {
    const { alunoId, inicio, fim } = req.query;

    let query = `
        SELECT 
            p.name AS aluno,
            COUNT(DISTINCT sp.session_id) AS qtd_aulas,
            SUM(sp.calories_total) AS total_calorias,
            SUM(sp.vo2_time_seconds) AS total_vo2_seg,
            AVG(sp.avg_hr) AS fc_media_geral,
            MAX(sp.max_hr_reached) AS fc_max_geral,
            SUM(sp.min_red) AS total_tempo_vermelho_min,
            SUM(sp.queima_points) AS total_queima_points,
            AVG(sp.trimp_total) AS trimp_medio,
            AVG(sp.epoc_estimated) AS epoc_medio
        FROM participants p
        LEFT JOIN session_participants sp ON sp.participant_id = p.id
        LEFT JOIN sessions s ON s.id = sp.session_id
        WHERE 1=1
    `;
    const params = [];
    let paramIndex = 1;

    if (alunoId) {
        query += ` AND p.id = $${paramIndex}`;
        params.push(alunoId);
        paramIndex++;
    }
    if (inicio) {
        query += ` AND s.date_start >= $${paramIndex}`;
        params.push(inicio);
        paramIndex++;
    }
    if (fim) {
        query += ` AND s.date_start <= $${paramIndex}`;
        params.push(fim);
        paramIndex++;
    }

    query += ` GROUP BY p.name ORDER BY total_calorias DESC`;

    try {
        const result = await pool.query(query, params);
        res.json(result.rows);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: 'Erro ao buscar ranking acumulado' });
    }
});

// Rota para histórico detalhado por aula
sessionsRouter.get('/sessions/historico', async (req, res) => {
    const { alunoId, inicio, fim } = req.query;

    let query = `
        SELECT 
            s.id AS id_sessao,
            s.class_name,
            s.date_start,
            s.date_end,
            s.duration_minutes,
            p.name AS aluno,
            sp.calories_total,
            sp.vo2_time_seconds,
            sp.avg_hr,
            sp.max_hr_reached,
            sp.min_red,
            sp.queima_points,
            sp.trimp_total,
            sp.epoc_estimated,
            sp.real_resting_hr
        FROM sessions s
        JOIN session_participants sp ON sp.session_id = s.id
        JOIN participants p ON p.id = sp.participant_id
        WHERE 1=1
    `;
    const params = [];
    let paramIndex = 1;

    if (alunoId) {
        query += ` AND p.id = $${paramIndex}`;
        params.push(alunoId);
        paramIndex++;
    }
    if (inicio) {
        query += ` AND s.date_start >= $${paramIndex}`;
        params.push(inicio);
        paramIndex++;
    }
    if (fim) {
        query += ` AND s.date_start <= $${paramIndex}`;
        params.push(fim);
        paramIndex++;
    }

    query += ` ORDER BY s.date_start DESC`;

    try {
        const result = await pool.query(query, params);
        res.json(result.rows);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: 'Erro ao buscar histórico' });
    }
});