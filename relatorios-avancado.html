<script>
    const API_BASE_URL = 'https://wodpulse-back.onrender.com';
    let rankingData = [];
    let historicoData = [];
    let sortDirection = {};
    let dispersaoChart = null;
    let linhaFCChart = null;

    // Carrega filtros ao abrir
    window.addEventListener('load', async () => {
        const selectAluno = document.getElementById('filter-aluno');
        const selectAula = document.getElementById('filter-aula');

        try {
            // Alunos
            const alunosRes = await fetch(`${API_BASE_URL}/api/participants`);
            const alunosData = await alunosRes.json();
            const alunos = alunosData.participants || [];
            alunos.sort((a,b) => a.name.localeCompare(b.name)).forEach(aluno => {
                const opt = document.createElement('option');
                opt.value = aluno.id;
                opt.textContent = aluno.name;
                selectAluno.appendChild(opt);
            });

            // Aulas únicas
            const aulasRes = await fetch(`${API_BASE_URL}/api/sessions`);
            const aulasData = await aulasRes.json();
            const aulas = aulasData.sessions || [];
            const aulasUnicas = [...new Set(aulas.map(a => a.class_name))];
            aulasUnicas.forEach(aula => {
                const opt = document.createElement('option');
                opt.value = aula;
                opt.textContent = aula;
                selectAula.appendChild(opt);
            });
        } catch (err) {
            console.error('Erro ao carregar filtros:', err);
        }

        carregarRelatorios();
    });

    async function carregarRelatorios() {
        document.getElementById('loading').style.display = 'block';

        const alunoId = document.getElementById('filter-aluno').value;
        const aulaNome = document.getElementById('filter-aula').value;
        const dataInicio = document.getElementById('filter-data-inicio').value;
        const dataFim = document.getElementById('filter-data-fim').value;

        try {
            // Ranking Acumulado
            let urlRanking = `${API_BASE_URL}/api/participants/ranking-acumulado`;
            const params = [];
            if (alunoId) params.push(`alunoId=${alunoId}`);
            if (dataInicio) params.push(`inicio=${dataInicio}`);
            if (dataFim) params.push(`fim=${dataFim}`);
            if (params.length > 0) urlRanking += '?' + params.join('&');

            const rankingRes = await fetch(urlRanking);
            if (!rankingRes.ok) throw new Error('Erro no ranking');
            rankingData = await rankingRes.json();
            renderRankingGeral(rankingData);

            // Histórico Detalhado
            let urlHistorico = `${API_BASE_URL}/api/sessions/historico`;
            const paramsHist = [];
            if (alunoId) paramsHist.push(`alunoId=${alunoId}`);
            if (aulaNome) paramsHist.push(`class_name=${encodeURIComponent(aulaNome)}`);
            if (dataInicio) paramsHist.push(`inicio=${dataInicio}`);
            if (dataFim) paramsHist.push(`fim=${dataFim}`);
            if (paramsHist.length > 0) urlHistorico += '?' + paramsHist.join('&');

            const historicoRes = await fetch(urlHistorico);
            if (!historicoRes.ok) throw new Error('Erro no histórico');
            historicoData = await historicoRes.json();
            renderHistoricoAulas(historicoData);
        } catch (err) {
            console.error('Erro ao carregar relatórios:', err);
            alert('Erro ao carregar dados: ' + err.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderRankingGeral(data) {
        const tbody = document.getElementById('ranking-geral').querySelector('tbody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="no-data">Nenhum dado encontrado com os filtros.</td></tr>';
        } else {
            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                if (index === 0) tr.classList.add('top1', 'highlight');
                if (index === 1) tr.classList.add('top2');
                if (index === 2) tr.classList.add('top3');

                tr.innerHTML = `
                    <td>${index + 1}º</td>
                    <td>${item.aluno}</td>
                    <td>${item.qtd_aulas}</td>
                    <td>${Math.round(item.total_calorias || 0)} kcal</td>
                    <td>${Math.round(item.total_vo2_seg || 0)} s</td>
                    <td>${Math.round(item.fc_media_geral || 0)} bpm</td>
                    <td>${Math.round(item.fc_max_geral || 0)} bpm</td>
                    <td>${Math.round(item.total_tempo_vermelho_min || 0)} min</td>
                    <td>${Math.round(item.total_queima_points || 0)} pts</td>
                    <td>${item.trimp_medio ? Number(item.trimp_medio).toFixed(2) : '0.00'}</td>
                    <td>${item.epoc_medio ? Number(item.epoc_medio).toFixed(2) : '0.00'} kcal</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Gráfico Dispersão FC Máx vs Calorias
        const ctx = document.getElementById('dispersaoChart').getContext('2d');
        if (dispersaoChart) dispersaoChart.destroy();
        dispersaoChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'FC Máx vs Calorias',
                    data: data.map(item => ({
                        x: Math.round(item.fc_max_geral || 0),
                        y: Math.round(item.total_calorias || 0),
                        label: item.aluno
                    })),
                    backgroundColor: '#FF9800',
                    pointRadius: 8,
                    pointHoverRadius: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'FC Máxima Geral (bpm)', color: '#FF9800' } },
                    y: { title: { display: true, text: 'Total Calorias', color: '#FF9800' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.raw.label}: ${ctx.raw.x} bpm, ${ctx.raw.y} kcal`
                        }
                    }
                }
            }
        });
    }

    function renderHistoricoAulas(data) {
        const tbody = document.getElementById('historico-aulas').querySelector('tbody');
        tbody.innerHTML = '';

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="15" class="no-data">Nenhum dado encontrado com os filtros.</td></tr>';
            document.getElementById('linhaChartContainer').style.display = 'none';
            return;
        }

        data.forEach(item => {
            const tr = document.createElement('tr');
            if (item.min_red > 0) tr.classList.add('red-zone');

            tr.innerHTML = `
                <td>${item.id_sessao}</td>
                <td>${item.class_name || 'Aula'}</td>
                <td>${new Date(item.date_start).toLocaleString('pt-BR')}</td>
                <td>${new Date(item.date_end).toLocaleString('pt-BR')}</td>
                <td>${item.duration_minutes || 0}</td>
                <td>${item.aluno}</td>
                <td>${Math.round(item.calories_total || 0)} kcal</td>
                <td>${Math.round(item.vo2_time_seconds || 0)} s</td>
                <td>${Math.round(item.avg_hr || 0)} bpm</td>
                <td>${Math.round(item.max_hr_reached || 0)} bpm</td>
                <td class="red-zone">${Math.round(item.min_red || 0)} min</td>
                <td>${Math.round(item.queima_points || 0)} pts</td>
                <td>${Number(item.trimp_total || 0).toFixed(2)}</td>
                <td>${Math.round(item.epoc_estimated || 0)} kcal</td>
                <td>${item.real_resting_hr || item.resting_hr || '--'} bpm</td>
            `;
            tbody.appendChild(tr);
        });

        // Gráfico Linha: FC Média + FC Máx + FC Repouso
        if (document.getElementById('filter-aluno').value) {
            document.getElementById('linhaChartContainer').style.display = 'block';
            document.getElementById('alunoSelecionado').textContent = document.getElementById('filter-aluno').options[document.getElementById('filter-aluno').selectedIndex].text;

            const ctx = document.getElementById('linhaFCChart').getContext('2d');
            if (linhaFCChart) linhaFCChart.destroy();

            const sortedData = data.sort((a,b) => new Date(a.date_start) - new Date(b.date_start));

            linhaFCChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedData.map(item => new Date(item.date_start).toLocaleDateString('pt-BR')),
                    datasets: [
                        {
                            label: 'FC Média por Aula',
                            data: sortedData.map(item => Math.round(item.avg_hr || 0)),
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255,152,0,0.2)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'FC Máxima por Aula',
                            data: sortedData.map(item => Math.round(item.max_hr_reached || 0)),
                            borderColor: '#FF1744',
                            backgroundColor: 'rgba(255,23,68,0.2)',
                            fill: false,
                            tension: 0.3,
                            borderDash: [5, 5],
                            yAxisID: 'y'
                        },
                        {
                            label: 'FC Repouso (cadastro)',
                            data: sortedData.map(item => Math.round(item.real_resting_hr || item.resting_hr || 0)),
                            borderColor: '#9E9E9E',
                            backgroundColor: 'rgba(158,158,158,0.2)',
                            fill: false,
                            tension: 0.1,
                            borderDash: [10, 5],
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Frequência Cardíaca (bpm)', color: '#FF9800' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} bpm`;
                                }
                            }
                        },
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    }
                }
            });
        } else {
            document.getElementById('linhaChartContainer').style.display = 'none';
        }
    }

    // Ordenação de colunas clicando no cabeçalho
    document.querySelectorAll('#ranking-geral th[data-sort], #historico-aulas th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const tableId = th.closest('table').id;
            const sortKey = th.dataset.sort;
            const direction = sortDirection[sortKey] = sortDirection[sortKey] === 'asc' ? 'desc' : 'asc';

            let data = tableId === 'ranking-geral' ? rankingData : historicoData;

            data.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (tableId === 'ranking-geral') renderRankingGeral(data);
            else renderHistoricoAulas(data);
        });
    });

    function exportToPDF() {
        const element = document.querySelector('.container');
        const opt = {
            margin: 1,
            filename: 'Relatorio_Avancado_WODPulse_' + new Date().toLocaleDateString('pt-BR') + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a3', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>