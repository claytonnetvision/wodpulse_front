<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Perfil - WODPulse</title>
    <link rel="stylesheet" href="style_tinder.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <a href="match_tinder.html" class="header-btn"><i class="fas fa-arrow-left"></i></a>
            <div id="headerUsername" class="logo-tinder">Perfil</div>
            <a href="#" class="header-btn"><i class="fas fa-cog"></i></a>
        </header>

        <main class="profile-content">
            <section class="profile-details-v2">
                <div class="profile-photo-container">
                    <img id="profileMainPhoto" src="https://i.imgur.com/3g7A8vW.png" alt="Foto do perfil" class="profile-main-photo">
                    <button id="editPhotoButton" class="btn-edit-photo" style="display: none;"><i class="fas fa-camera"></i></button>
                    <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
                </div>

                <div class="profile-info-v2">
                    <h1 id="profileName">Carregando...</h1>
                    <p id="profileBio">Buscando informa√ß√µes...</p>
                    
                    <div id="otherUserActions" class="profile-action-buttons" style="display: none;">
                        <a id="challengeButton" href="#" class="btn-profile-action challenge">üèÜ Desafiar</a>
                        <a id="chatButton" href="#" class="btn-profile-action chat">üí¨ Conversar</a>
                    </div>

                    <div id="selfUserActions" class="profile-action-buttons" style="display: none;">
                        <a href="desafio_painel.html" class="btn-profile-action challenge">‚öîÔ∏è Meus Desafios</a>
                        <a href="#" class="btn-profile-action chat">‚öôÔ∏è Editar Perfil</a>
                    </div>
                </div>
            </section>

            <section id="notificationsSection" class="notifications-section" style="display: none;">
                <div class="panel-header">
                    <h3>Novas Mensagens</h3>
                </div>
                <div id="notificationsContainer"></div>
            </section>

            <section class="photo-panel-section">
                <div class="panel-header">
                    <h3>Minhas Fotos</h3>
                    <button id="addPhotoButton" class="btn-add-photo" style="display: none;"><i class="fas fa-plus"></i> Adicionar</button>
                    <input type="file" id="photoUploadInput" accept="image/*" style="display: none;">
                </div>
                <div id="photoPanelGrid" class="photo-panel-grid">
                    <p class="loading-text">Carregando fotos...</p>
                </div>
            </section>

            <section id="performanceStatsSection" class="performance-stats-section">
                <h3 class="section-title">Resumo de Performance</h3>
                <div id="performanceStatsGrid" class="performance-stats-grid">
                    <p class="loading-text">Carregando estat√≠sticas...</p>
                </div>
                <a id="fullProgressButton" href="#" class="btn-full-progress">
                    <i class="fas fa-chart-line"></i> Ver Progresso Completo
                </a>
            </section>

            <section id="chartsSection" class="charts-section">
                <h3 class="section-title">An√°lise de Performance</h3>
                <div class="chart-container">
                    <canvas id="chartCalorias"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="chartPizzaZonas"></canvas>
                </div>
            </section>
        </main>
    </div>

    <div id="photoModal" class="photo-modal-overlay">
        <div class="photo-modal-content">
            <span class="close-modal-btn" onclick="closePhotoModal( )">&times;</span>
            <img id="modalPhotoImage" src="" alt="Foto ampliada">
            <div class="photo-comments-section">
                <div id="modalCommentsContainer" class="comments-container"></div>
                <div class="comment-input-area">
                    <input type="text" id="commentInput" placeholder="Adicione um coment√°rio...">
                    <button onclick="postComment()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token' );
        const selfId = localStorage.getItem('wodpulse_aluno_id');
        
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('id') || selfId;
        const isOwnProfile = (String(targetId) === String(selfId));

        let currentOpenPhotoId = null;

        console.log(`[DEBUG] Iniciando perfil. √â o pr√≥prio perfil? ${isOwnProfile}. ID do Alvo: ${targetId}`);

        if (!token || !targetId) {
            alert('Token ou ID do alvo n√£o encontrado. Fa√ßa login novamente.');
            console.error(`[DEBUG] Token: ${token}, Target ID: ${targetId}`);
        }

        document.getElementById('fullProgressButton').href = `meu-progresso.html?id=${targetId}`;

        function formatPhoto(photo) {
            if (!photo) return 'https://i.imgur.com/3g7A8vW.png';
            if (photo.startsWith('data:image' ) || photo.startsWith('http' )) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        async function loadParticipantData() {
            console.log(`[DEBUG] 1. Buscando dados b√°sicos do participante ID: ${targetId}`);
            const endpoint = isOwnProfile ? '/api/social/profile' : `/api/public-profile/${targetId}`;
            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error(`Erro ${res.status} ao buscar dados do participante.`);
                const user = await res.json();
                
                console.log('[DEBUG] 1.1. Dados b√°sicos recebidos:', user);

                document.getElementById('headerUsername').textContent = user.name.split(' ')[0];
                document.getElementById('profileName').textContent = `${user.name}, ${user.age || 'N/A'}`;
                document.getElementById('profileBio').textContent = user.bio || 'Atleta WODPulse | Adicione sua bio!';
                document.getElementById('profileMainPhoto').src = formatPhoto(user.photo);
                
            } catch (err) {
                document.getElementById('profileName').textContent = 'Erro ao carregar perfil.';
                console.error(err);
            }
        }

        async function loadUserPhotos() {
            console.log(`[DEBUG] 2. Buscando fotos do √°lbum para o ID: ${targetId}`);
            const panelGrid = document.getElementById('photoPanelGrid');
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/${targetId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const photos = await res.json();
                console.log(`[DEBUG] 2.1. Fotos recebidas: ${photos.length}`);

                if (photos.length === 0) {
                    panelGrid.innerHTML = isOwnProfile ? '' : '<p class="loading-text">Nenhuma foto no painel.</p>';
                    return;
                }
                
                panelGrid.innerHTML = photos.map(photo => `
                    <div id="photo-item-${photo.id}" class="photo-panel-item" data-owner-id="${photo.user_id}" onclick="openPhotoModal(${photo.id}, '${formatPhoto(photo.photo_data)}')">
                        <img src="${formatPhoto(photo.photo_data)}" alt="Foto do painel">
                        ${isOwnProfile ? `<button class="btn-delete-photo" onclick="event.stopPropagation(); deletePhoto(${photo.id});"><i class="fas fa-times"></i></button>` : ''}
                    </div>
                `).join('');

            } catch (err) {
                console.error('[DEBUG] 2.2. Erro ao buscar fotos.', err);
                panelGrid.innerHTML = '<p class="loading-text" style="color: var(--accent-pass);">Erro ao carregar fotos.</p>';
            }
        }

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const photoData = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });

            console.log('[DEBUG] 4. Enviando nova foto para a API...');
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoData: photoData, privacy: 'public' })
                });
                if (!res.ok) throw new Error('Falha no upload da foto.');
                console.log('[DEBUG] 4.1. Foto enviada com sucesso. Recarregando painel.');
                alert('Foto adicionada com sucesso!');
                loadUserPhotos();
            } catch (err) {
                console.error('[DEBUG] 4.2. Erro no upload:', err);
                alert('Erro ao enviar a foto.');
            }
        }
        
        async function deletePhoto(photoId) {
            if (!confirm('Tem certeza que deseja excluir esta foto?')) return;
            console.log(`[DEBUG] 5. Tentando deletar foto ID: ${photoId}`);
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/${photoId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `Erro ${res.status} ao excluir a foto.`);
                }
                console.log(`[DEBUG] 5.1. Foto ${photoId} deletada com sucesso.`);
                alert('Foto exclu√≠da com sucesso!');
                loadUserPhotos();
            } catch (err) {
                console.error('[DEBUG] 5.2. Erro ao deletar foto:', err);
                alert(`Erro: ${err.message}`);
            }
        }

        async function loadPerformanceData() {
            console.log(`[DEBUG] 3. Buscando hist√≥rico de treinos para o ID: ${targetId}`);
            const endpoint = `/api/social/user-history?alunoId=${targetId}`;
            const statsGrid = document.getElementById('performanceStatsGrid');
            const chartsSection = document.getElementById('chartsSection');

            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error(`Erro ${res.status} ao carregar o hist√≥rico.`);
                const historico = await res.json();
                console.log(`[DEBUG] 3.1. Hist√≥rico de treinos recebido: ${historico.length} aulas.`);

                if (historico.length === 0) {
                    statsGrid.innerHTML = '<p class="loading-text">Nenhum treino registrado.</p>';
                    chartsSection.style.display = 'none';
                    return;
                }

                const totalSessions = historico.length;
                const totalCalories = historico.reduce((sum, t) => sum + (parseFloat(t.calories_total) || 0), 0);
                const avgCalories = totalSessions > 0 ? Math.round(totalCalories / totalSessions) : 0;
                const maxHr = Math.max(0, ...historico.map(t => parseFloat(t.max_hr_reached) || 0));
                const totalVo2Minutes = Math.round(historico.reduce((sum, t) => sum + (parseFloat(t.vo2_time_seconds) || 0), 0) / 60);

                statsGrid.innerHTML = `
                    <div class="stat-card"><span class="stat-value">${totalSessions}</span><span class="stat-label">Aulas</span></div>
                    <div class="stat-card"><span class="stat-value">${Math.round(totalCalories)}</span><span class="stat-label">Kcal Totais</span></div>
                    <div class="stat-card"><span class="stat-value">${avgCalories}</span><span class="stat-label">M√©dia/Aula</span></div>
                    <div class="stat-card"><span class="stat-value">${maxHr}</span><span class="stat-label">FC M√°x</span></div>
                    <div class="stat-card"><span class="stat-value">${totalVo2Minutes}</span><span class="stat-label">Min em VO‚ÇÇ</span></div>`;

                renderChartCalorias(historico);
                renderChartPizzaZonas(historico);

            } catch (err) {
                statsGrid.innerHTML = `<p class="loading-text" style="color: var(--accent-pass);">${err.message}</p>`;
                chartsSection.style.display = 'none';
                console.error("[DEBUG] 3.2. Erro ao carregar dados de performance:", err);
            }
        }

        function renderChartCalorias(historico) {
            const ctx = document.getElementById('chartCalorias').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historico.slice(0, 10).map(h => new Date(h.date_start).toLocaleDateString('pt-BR')).reverse(),
                    datasets: [{
                        label: 'Calorias por Aula (√öltimos 10)',
                        data: historico.slice(0, 10).map(h => Math.round(h.calories_total || 0)).reverse(),
                        borderColor: 'rgba(45, 225, 156, 0.8)',
                        backgroundColor: 'rgba(45, 225, 156, 0.1)',
                        borderWidth: 2, tension: 0.3, fill: true,
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#fff' } } }, scales: { y: { ticks: { color: '#888' } }, x: { ticks: { color: '#888' } } } }
            });
        }

        function renderChartPizzaZonas(historico) {
            const totalZ2 = historico.reduce((s, h) => s + (h.min_zone2 || 0), 0);
            const totalZ3 = historico.reduce((s, h) => s + (h.min_zone3 || 0), 0);
            const totalZ4 = historico.reduce((s, h) => s + (h.min_zone4 || 0), 0);
            const totalZ5 = historico.reduce((s, h) => s + (h.min_zone5 || 0), 0);
            const totalRed = historico.reduce((s, h) => s + (h.min_red || 0), 0);
            const ctx = document.getElementById('chartPizzaZonas').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Zona 2', 'Zona 3', 'Zona 4', 'Zona 5', 'Vermelha'],
                    datasets: [{
                        label: 'Minutos nas Zonas',
                        data: [totalZ2, totalZ3, totalZ4, totalZ5, totalRed],
                        backgroundColor: ['#4CAF50', '#8BC34A', '#FFC107', '#FF5722', '#F44336'],
                        borderColor: '#222', borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff', boxWidth: 15 } } } }
            });
        }

        function openPhotoModal(photoId, photoUrl) {
            currentOpenPhotoId = photoId;
            document.getElementById('modalPhotoImage').src = photoUrl;
            document.getElementById('photoModal').style.display = 'flex';
            loadPhotoComments(photoId);
        }

        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
            currentOpenPhotoId = null;
        }

        async function loadPhotoComments(photoId) {
            const commentsContainer = document.getElementById('modalCommentsContainer');
            commentsContainer.innerHTML = '<p class="loading-text">Carregando coment√°rios...</p>';
            console.log(`[DEBUG] 6. Buscando coment√°rios para a foto ID: ${photoId}`);
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/${photoId}/comments`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Falha ao carregar coment√°rios.');
                const comments = await res.json();
                
                const photoOwnerId = document.getElementById(`photo-item-${photoId}`)?.dataset.ownerId;

                if (comments.length === 0) {
                    commentsContainer.innerHTML = '<p class="loading-text">Nenhum coment√°rio ainda. Seja o primeiro!</p>';
                    return;
                }

                commentsContainer.innerHTML = comments.map(comment => {
                    const canDelete = (String(selfId) === String(comment.user_id)) || (String(selfId) === String(photoOwnerId));
                    return `
                        <div class="comment-item">
                            <img src="${formatPhoto(comment.user_photo)}" class="comment-user-photo" alt="${comment.user_name}">
                            <div class="comment-content">
                                <strong>${comment.user_name}</strong>
                                <p>${comment.content}</p>
                            </div>
                            ${canDelete ? `<button class="btn-delete-comment" onclick="deleteComment(${comment.id})"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error(err);
                commentsContainer.innerHTML = `<p class="loading-text" style="color: red;">${err.message}</p>`;
            }
        }

        async function postComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            if (!content || !currentOpenPhotoId) return;

            console.log(`[DEBUG] 7. Postando coment√°rio "${content}" na foto ID: ${currentOpenPhotoId}`);
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/${currentOpenPhotoId}/comments`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });
                if (!res.ok) throw new Error('Falha ao postar coment√°rio.');
                
                input.value = '';
                loadPhotoComments(currentOpenPhotoId);

            } catch (err) {
                console.error(err);
                alert('Erro ao enviar coment√°rio.');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('Tem certeza que deseja excluir este coment√°rio?')) return;

            console.log(`[DEBUG] 9. Tentando deletar coment√°rio ID: ${commentId}`);
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Falha ao excluir coment√°rio.');
                }
                console.log(`[DEBUG] 9.1. Coment√°rio ${commentId} deletado. Recarregando.`);
                loadPhotoComments(currentOpenPhotoId);
            } catch (err) {
                console.error('[DEBUG] 9.2. Erro ao deletar coment√°rio:', err);
                alert(`Erro: ${err.message}`);
            }
        }

        async function loadMessageNotifications() {
            if (!isOwnProfile) return;
            console.log('[DEBUG] 8. Buscando notifica√ß√µes de mensagens...');
            const notificationsContainer = document.getElementById('notificationsContainer');
            const notificationsSection = document.getElementById('notificationsSection');
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/messages/notifications`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Falha ao buscar notifica√ß√µes.');
                const notifications = await res.json();
                console.log(`[DEBUG] 8.1. Notifica√ß√µes recebidas: ${notifications.length}`);
                if (notifications.length === 0) {
                    notificationsSection.style.display = 'none';
                    return;
                }
                notificationsSection.style.display = 'block';
                notificationsContainer.innerHTML = notifications.map(notif => `
                    <a href="chat_tinder.html?id=${notif.sender_id}" class="notification-item">
                        <img src="${formatPhoto(notif.sender_photo)}" alt="${notif.sender_name}" class="notification-user-photo">
                        <div class="notification-text">
                            <strong>${notif.sender_name}</strong> te enviou uma nova mensagem.
                        </div>
                        <span class="notification-badge">${notif.unread_count}</span>
                    </a>
                `).join('');
            } catch (err) {
                console.error('[DEBUG] 8.2. Erro ao buscar notifica√ß√µes:', err);
                notificationsSection.style.display = 'none';
            }
        }
function setRealViewportHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}
        // SUBSTITUA A FUN√á√ÉO ANTIGA PELA NOVA NO SCRIPT DE perfil_tinder.html
async function handleProfilePhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const photoBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    console.log('[DEBUG] Enviando nova foto de perfil para a API...');
    try {
        // USA A NOVA ROTA, MAIS SEGURA E ESPEC√çFICA
        const res = await fetch(`${API_BASE_URL}/api/social/profile/photo`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ photo: photoBase64 })
        });

        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || 'Falha ao atualizar a foto de perfil.');
        }
        
        console.log('[DEBUG] Foto de perfil atualizada com sucesso.');
        alert('Foto de perfil atualizada! A p√°gina ser√° recarregada.');
        window.location.reload();

    } catch (err) {
        console.error('[DEBUG] Erro ao atualizar foto de perfil:', err);
        alert(`Erro ao atualizar a foto: ${err.message}`);
    }
}


        async function initializeProfile() {
            if (isOwnProfile) {
                document.getElementById('addPhotoButton').style.display = 'block';
                document.getElementById('editPhotoButton').style.display = 'block';

                document.getElementById('addPhotoButton').addEventListener('click', () => document.getElementById('photoUploadInput').click());
                document.getElementById('photoUploadInput').addEventListener('change', handlePhotoUpload);
                
                document.getElementById('editPhotoButton').addEventListener('click', () => document.getElementById('profilePhotoInput').click());
                document.getElementById('profilePhotoInput').addEventListener('change', handleProfilePhotoUpload);

                document.getElementById('selfUserActions').style.display = 'flex';
                loadMessageNotifications();
            } else {
                document.getElementById('otherUserActions').style.display = 'flex';
                document.getElementById('challengeButton').href = `criar_desafio.html?opponentId=${targetId}`;
                document.getElementById('chatButton').href = `chat_tinder.html?id=${targetId}`;
            }
            await loadParticipantData();
            await loadUserPhotos();
            await loadPerformanceData();
        }

        initializeProfile();
        // ADICIONE ESTAS LINHAS AO FINAL DO <script> DE CADA ARQUIVO

// Ajusta a altura da viewport ao carregar e ao redimensionar
window.addEventListener('resize', setRealViewportHeight);
setRealViewportHeight(); // Chama a fun√ß√£o uma vez no carregamento inicial

    </script>
</body>
</html>
