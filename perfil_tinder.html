<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Perfil - WODPulse</title>
    <link rel="stylesheet" href="style_tinder.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <a href="match_tinder.html" class="header-btn"><i class="fas fa-arrow-left"></i></a>
            <div id="headerUsername" class="logo-tinder">Perfil</div>
            <a href="#" class="header-btn"><i class="fas fa-cog"></i></a>
        </header>

        <main class="profile-content">
            <!-- GALERIA DE FOTOS -->
            <section id="photoGallery" class="photo-gallery">
                <!-- Fotos ser√£o carregadas aqui -->
                <div class="photo-grid-item main-photo" style="background-image: url('https://via.placeholder.com/400' );"></div>
                <div class="photo-grid-item" style="background-image: url('https://via.placeholder.com/400' );"></div>
                <div class="photo-grid-item" style="background-image: url('https://via.placeholder.com/400' );"></div>
                <div id="addPhotoButton" class="photo-grid-item add-photo-btn">
                    <i class="fas fa-plus"></i>
                </div>
            </section>

            <!-- INFORMA√á√ïES DO PERFIL -->
            <section class="profile-details">
                <h1 id="profileName">Carregando...</h1>
                <p id="profileBio">Buscando informa√ß√µes do perfil...</p>
            </section>

            <!-- STATS DE PERFORMANCE -->
            <section id="performanceStats" class="performance-stats">
                <!-- Stats ser√£o carregados aqui -->
            </section>
        </main>

        <!-- BOT√ïES DE A√á√ÉO (VISUALIZANDO OUTRO PERFIL) -->
        <footer id="profileActionFooter" class="actions-footer" style="display: none;">
            <button class="action-btn btn-pass"><i class="fas fa-times"></i></button>
            <button class="action-btn btn-superlike"><i class="fas fa-star"></i></button>
            <button class="action-btn btn-like"><i class="fas fa-heart"></i></button>
        </footer>
    </div>

    <!-- =================================== -->
    <!-- SCRIPT DE INTEGRA√á√ÉO DO PERFIL -->
    <!-- =================================== -->
    <script>
        const API_BASE_URL = 'https://wodpulse-back.onrender.com';
        const token = localStorage.getItem('wodpulse_social_token' );
        const selfId = localStorage.getItem('wodpulse_aluno_id');
        
        const urlParams = new URLSearchParams(window.location.search);
        // Se n√£o houver ID na URL, assume que √© o perfil do pr√≥prio usu√°rio
        const targetId = urlParams.get('id') || selfId;
        const isOwnProfile = (targetId === selfId);

        if (!token) {
            alert('Token n√£o encontrado. Fa√ßa login.');
        }

        function formatPhoto(photo) {
            if (!photo) return 'https://www.infrapower.com.br/logo-v6.png';
            if (photo.startsWith('data:image' ) || photo.startsWith('http' )) return photo;
            return `data:image/jpeg;base64,${photo}`;
        }

        async function loadProfileData() {
            const endpoint = isOwnProfile ? '/api/social/profile' : `/api/social/public-profile/${targetId}`;
            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Perfil n√£o encontrado.');
                
                const user = await res.json();

                // Preenche informa√ß√µes b√°sicas
                document.getElementById('headerUsername').textContent = user.name.split(' ')[0];
                document.getElementById('profileName').textContent = `${user.name}, ${user.age || 25}`;
                document.getElementById('profileBio').textContent = user.bio || 'Atleta WODPulse | Adicione sua bio!';

                // Carrega as fotos (usando a rota de fotos que voc√™ j√° tem)
                loadUserPhotos(user.photo); // Passa a foto principal como fallback

            } catch (err) {
                document.getElementById('profileName').textContent = 'Erro ao carregar perfil.';
                console.error(err);
            }
        }

        async function loadUserPhotos(mainPhoto) {
            const gallery = document.getElementById('photoGallery');
            try {
                const res = await fetch(`${API_BASE_URL}/api/social/photos/${targetId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const photos = await res.json();

                gallery.innerHTML = ''; // Limpa o conte√∫do
                
                // Adiciona a foto principal primeiro
                const mainPhotoUrl = photos.length > 0 ? formatPhoto(photos[0].photo_data) : formatPhoto(mainPhoto);
                gallery.innerHTML += `<div class="photo-grid-item main-photo" style="background-image: url('${mainPhotoUrl}');"></div>`;

                // Adiciona as outras fotos
                photos.slice(1).forEach(p => {
                    gallery.innerHTML += `<div class="photo-grid-item" style="background-image: url('${formatPhoto(p.photo_data)}');"></div>`;
                });

                // Se for o pr√≥prio perfil, mostra o bot√£o de adicionar
                if (isOwnProfile) {
                    gallery.innerHTML += `<div id="addPhotoButton" class="photo-grid-item add-photo-btn"><i class="fas fa-plus"></i></div>`;
                }

            } catch (err) {
                gallery.innerHTML = `<div class="photo-grid-item main-photo" style="background-image: url('${formatPhoto(mainPhoto)}');"></div>`;
                if (isOwnProfile) {
                    gallery.innerHTML += `<div id="addPhotoButton" class="photo-grid-item add-photo-btn"><i class="fas fa-plus"></i></div>`;
                }
                console.warn("N√£o foi poss√≠vel carregar o √°lbum de fotos, usando apenas a foto de perfil.");
            }
        }

        async function loadPerformanceStats() {
            // Esta rota √© segura e s√≥ funciona para o pr√≥prio usu√°rio
            if (!isOwnProfile) {
                document.getElementById('performanceStats').style.display = 'none';
                return;
            }
            try {
                const res = await fetch(`${API_BASE_URL}/api/stats/my-progress`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                const stats = result.data;

                document.getElementById('performanceStats').innerHTML = `
                    <div class="stat-pill">üî• ${stats.total_calories} kcal</div>
                    <div class="stat-pill">üí™ ${stats.total_sessions} treinos</div>
                    <div class="stat-pill">‚ù§Ô∏è ${stats.max_hr} bpm max</div>
                `;
            } catch (err) {
                console.error("Erro ao carregar stats de performance:", err);
            }
        }

        function setupUI() {
            if (isOwnProfile) {
                document.getElementById('profileActionFooter').style.display = 'none';
            } else {
                document.getElementById('profileActionFooter').style.display = 'flex';
            }
        }

        // Inicia o carregamento
        setupUI();
        loadProfileData();
        loadPerformanceStats();

    </script>
</body>
</html>
